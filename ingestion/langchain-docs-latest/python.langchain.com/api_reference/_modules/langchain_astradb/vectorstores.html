
<!DOCTYPE html>

<html data-content_root="../../" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9B66JQQH2F"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-9B66JQQH2F');
    </script>
<title>langchain_astradb.vectorstores â€” ðŸ¦œðŸ”— LangChain  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
<!--
    this give us a css class that will be invisible only if js is disabled
  -->
<noscript>
<style>
      .pst-js-only { display: none !important; }

    </style>
</noscript>
<!-- Loaded before other Sphinx assets -->
<link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet"/>
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet"/>
<link href="../../_static/pygments.css?v=8f2a1f02" rel="stylesheet" type="text/css"/>
<link href="../../_static/autodoc_pydantic.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../../_static/sphinx-design.min.css?v=95c83b7e" rel="stylesheet" type="text/css"/>
<link href="../../_static/css/custom.css?v=8e9fa5b3" rel="stylesheet" type="text/css"/>
<!-- So that users can add custom icons -->
<script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" rel="preload"/>
<link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" rel="preload"/>
<script src="../../_static/documentation_options.js?v=3b5cce75"></script>
<script src="../../_static/doctools.js?v=9bcbadda"></script>
<script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../../_static/copybutton.js?v=f281be69"></script>
<script src="../../_static/design-tabs.js?v=f930bc37"></script>
<script>DOCUMENTATION_OPTIONS.pagename = '_modules/langchain_astradb/vectorstores';</script>
<link href="../../_static/favicon.png" rel="icon"/>
<link href="../../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
<meta content="" name="docsearch:version"/>
<meta content="Jul 10, 2025" name="docbuild:last-update"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<dialog id="pst-search-dialog">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</dialog>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
<button aria-label="Site navigation" class="pst-navbar-icon sidebar-toggle primary-toggle">
<span class="fa-solid fa-bars"></span>
</button>
<div class="navbar-header-items__start">
<div class="navbar-item">
<a class="navbar-brand logo" href="../../index.html">
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-light" src="../../_static/wordmark-api.svg"/>
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-dark pst-js-only" src="../../_static/wordmark-api-dark.svg"/>
</a></div>
</div>
<div class="navbar-header-items">
<div class="me-auto navbar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../reference.html">
    Reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="navbar-header-items__end">
<div class="navbar-item navbar-persistent--container">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<button aria-label="Color mode" class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" data-bs-placement="bottom" data-bs-title="Color mode" data-bs-toggle="tooltip">
<i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light" title="Light"></i>
<i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark" title="Dark"></i>
<i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto" title="System Settings"></i>
</button></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="navbar-persistent--mobile">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<dialog id="pst-primary-sidebar-modal"></dialog>
<div class="bd-sidebar-primary bd-sidebar hide-on-wide" id="pst-primary-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../reference.html">
    Reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<button aria-label="Color mode" class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" data-bs-placement="bottom" data-bs-title="Color mode" data-bs-toggle="tooltip">
<i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light" title="Light"></i>
<i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark" title="Dark"></i>
<i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto" title="System Settings"></i>
</button></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
<div class="sidebar-primary-item">
<div class="flat" data-ea-manual="true" data-ea-publisher="readthedocs" data-ea-type="readthedocs-sidebar" id="ethical-ad-placement">
</div></div>
</div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item">
<nav aria-label="Breadcrumb" class="d-print-none">
<ul class="bd-breadcrumbs">
<li class="breadcrumb-item breadcrumb-home">
<a aria-label="Home" class="nav-link" href="../../index.html">
<i class="fa-solid fa-home"></i>
</a>
</li>
<li class="breadcrumb-item"><a class="nav-link" href="../index.html">Module code</a></li>
<li aria-current="page" class="breadcrumb-item active"><span class="ellipsis">langchain_astradb.vectorstores</span></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<h1>Source code for langchain_astradb.vectorstores</h1><div class="highlight"><pre>
<span></span><span class="sd">"""Astra DB vector store integration."""</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncIterable</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">CollectionInsertManyException</span><span class="p">,</span> <span class="n">DataAPIResponseException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.info</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CollectionLexicalOptions</span><span class="p">,</span>
    <span class="n">CollectionRerankOptions</span><span class="p">,</span>
    <span class="n">VectorServiceOptions</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.vectorstores.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">maximal_marginal_relevance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">gather_with_concurrency</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">VectorStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">override</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_astradb.utils.astradb</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">COMPONENT_NAME_VECTORSTORE</span><span class="p">,</span>
    <span class="n">DEFAULT_DOCUMENT_CHUNK_SIZE</span><span class="p">,</span>
    <span class="n">MAX_CONCURRENT_DOCUMENT_DELETIONS</span><span class="p">,</span>
    <span class="n">MAX_CONCURRENT_DOCUMENT_INSERTIONS</span><span class="p">,</span>
    <span class="n">MAX_CONCURRENT_DOCUMENT_REPLACEMENTS</span><span class="p">,</span>
    <span class="n">HybridSearchMode</span><span class="p">,</span>
    <span class="n">SetupMode</span><span class="p">,</span>
    <span class="n">_AstraDBCollectionEnvironment</span><span class="p">,</span>
    <span class="n">_survey_collection</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_astradb.utils.vector_store_autodetect</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_detect_document_codec</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_astradb.utils.vector_store_codecs</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LEXICAL_FIELD_NAME</span><span class="p">,</span>
    <span class="n">VECTOR_FIELD_NAME</span><span class="p">,</span>
    <span class="n">VECTORIZE_FIELD_NAME</span><span class="p">,</span>
    <span class="n">_AstraDBVectorStoreDocumentCodec</span><span class="p">,</span>
    <span class="n">_DefaultVectorizeVSDocumentCodec</span><span class="p">,</span>
    <span class="n">_DefaultVSDocumentCodec</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.api_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIOptions</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.authentication</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">EmbeddingHeadersProvider</span><span class="p">,</span>
        <span class="n">RerankingHeadersProvider</span><span class="p">,</span>
        <span class="n">TokenProvider</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.cursors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RerankedResult</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.info</span><span class="w"> </span><span class="kn">import</span> <span class="n">RerankServiceOptions</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astrapy.results</span><span class="w"> </span><span class="kn">import</span> <span class="n">CollectionUpdateResult</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.embeddings</span><span class="w"> </span><span class="kn">import</span> <span class="n">Embeddings</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"T"</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"U"</span><span class="p">)</span>
<span class="n">DocDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># dicts expressing entries to insert</span>

<span class="c1"># error code to check for during bulk insertions</span>
<span class="n">DOCUMENT_ALREADY_EXISTS_API_ERROR_CODE</span> <span class="o">=</span> <span class="s2">"DOCUMENT_ALREADY_EXISTS"</span>
<span class="c1"># max number of errors shown in full insertion error messages</span>
<span class="n">MAX_SHOWN_INSERTION_ERRORS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1"># key for the 'rerank' score within the find_and_rerank scores</span>
<span class="n">RERANK_SCORE_KEY</span> <span class="o">=</span> <span class="s2">"$rerank"</span>
<span class="c1"># Error message for receiving a lexical_query for a non-hybrid search</span>
<span class="n">ERROR_LEXICAL_QUERY_ON_NONHYBRID_SEARCH</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">"Parameter 'lexical_query' cannot be passed for a non-hybrid search"</span>
<span class="p">)</span>
<span class="c1"># Warning message for retrieving scores on a hybrid search</span>
<span class="n">WARNING_HYBRID_SEARCH_WITH_SCORES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">"Scores returned as part of a hybrid search, which come from the "</span>
    <span class="s2">"reranking step, may not be deterministically computed solely based "</span>
    <span class="s2">"on the query and result. Using the scores e.g. for "</span>
    <span class="s2">"threshold-filtering may lead to unpredictable results and is discouraged."</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AstraDBQueryResult">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBQueryResult.html#langchain_astradb.vectorstores.AstraDBQueryResult">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AstraDBQueryResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""The complete information contained in a vector store entry.</span>

<span class="sd">    This class represents all that can be returned from the collection when running</span>
<span class="sd">    a query, which goes beyond just the corresponding Document.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        document: a ``langchain.schema.Document`` object representing the query result.</span>
<span class="sd">        id: the ID of the returned document.</span>
<span class="sd">        embedding: the embedding vector associated to the document. This may be None,</span>
<span class="sd">            depending on whether the embeddings were requested in the query or not.</span>
<span class="sd">        similarity: the numeric similarity score of the document in the query. In case</span>
<span class="sd">            this quantity was not requested by the query, it will be set to None.</span>
<span class="sd">    """</span>

    <span class="n">document</span><span class="p">:</span> <span class="n">Document</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">similarity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="HybridLimitFactorPrescription">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.HybridLimitFactorPrescription.html#langchain_astradb.vectorstores.HybridLimitFactorPrescription">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HybridLimitFactorPrescription</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A per-subsearch setting for the hybrid-search 'limit' factors.</span>

<span class="sd">    This structure is to be used to set different values for</span>
<span class="sd">    the vector and the lexical portions of the hybrid search.</span>

<span class="sd">    Each of the attributes is a floating-point number, representing the multiplicative</span>
<span class="sd">    factor applied to a search final 'k' to calculate the "limit" value for</span>
<span class="sd">    the associated sub-search. For instance, if vector=1.5 and lexical=3.0,</span>
<span class="sd">    a hybrid search called by asking a final set of k=4 results will be executed</span>
<span class="sd">    with limits of 6 for vector and 12 for lexical. (The results are approximated</span>
<span class="sd">    to an integer.)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        vector: the multiplicative factor for the "vector" part of the hybrid search.</span>
<span class="sd">        lexical: the multiplicative factor for the "lexical" part of the hybrid search.</span>
<span class="sd">    """</span>

    <span class="n">vector</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">lexical</span><span class="p">:</span> <span class="nb">float</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_unique_list</span><span class="p">(</span><span class="n">lst</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="n">U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="n">visited_keys</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">U</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">new_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">item_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_keys</span><span class="p">:</span>
            <span class="n">visited_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item_key</span><span class="p">)</span>
            <span class="n">new_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_lst</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_normalize_content_field</span><span class="p">(</span>
    <span class="n">content_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">is_autodetect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">has_vectorize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">has_vectorize</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"content_field is not configurable for vectorize collections."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">VECTORIZE_FIELD_NAME</span>

    <span class="k">if</span> <span class="n">content_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"*"</span> <span class="k">if</span> <span class="n">is_autodetect</span> <span class="k">else</span> <span class="s2">"content"</span>

    <span class="k">if</span> <span class="n">content_field</span> <span class="o">==</span> <span class="s2">"*"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_autodetect</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"content_field='*' illegal if autodetect_collection is False."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content_field</span>

    <span class="k">return</span> <span class="n">content_field</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_autodetect_init_params</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">setup_mode</span><span class="p">:</span> <span class="n">SetupMode</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">metadata_indexing_include</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata_indexing_exclude</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">collection_indexing_policy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">collection_vector_service_options</span><span class="p">:</span> <span class="n">VectorServiceOptions</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">collection_rerank</span><span class="p">:</span> <span class="n">CollectionRerankOptions</span> <span class="o">|</span> <span class="n">RerankServiceOptions</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">collection_lexical</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">CollectionLexicalOptions</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Check that the passed parameters do not violate the autodetect constraints."""</span>
    <span class="n">forbidden_parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">p_name</span>
        <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p_value</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">"metric"</span><span class="p">,</span> <span class="n">metric</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"metadata_indexing_include"</span><span class="p">,</span> <span class="n">metadata_indexing_include</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"metadata_indexing_exclude"</span><span class="p">,</span> <span class="n">metadata_indexing_exclude</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"collection_indexing_policy"</span><span class="p">,</span> <span class="n">collection_indexing_policy</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"collection_vector_service_options"</span><span class="p">,</span> <span class="n">collection_vector_service_options</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"collection_rerank"</span><span class="p">,</span> <span class="n">collection_rerank</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"collection_lexical"</span><span class="p">,</span> <span class="n">collection_lexical</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">]</span>
    <span class="n">fp_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">forbidden_parameters</span><span class="p">:</span>
        <span class="n">fp_error</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Parameter(s) </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forbidden_parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">. were provided "</span>
            <span class="s2">"but cannot be passed."</span>
        <span class="p">)</span>
    <span class="n">pd_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pre_delete_collection</span><span class="p">:</span>
        <span class="n">pd_error</span> <span class="o">=</span> <span class="s2">"Parameter `pre_delete_collection` cannot be True."</span>
    <span class="n">sm_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">setup_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sm_error</span> <span class="o">=</span> <span class="s2">"Parameter `setup_mode` not allowed."</span>
    <span class="n">am_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">err_s</span> <span class="k">for</span> <span class="n">err_s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fp_error</span><span class="p">,</span> <span class="n">pd_error</span><span class="p">,</span> <span class="n">sm_error</span><span class="p">)</span> <span class="k">if</span> <span class="n">err_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">am_errors</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Invalid parameters for autodetect mode: </span><span class="si">{</span><span class="s1">'; '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">am_errors</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_decide_hybrid_search_setting</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">required_hybrid_search</span><span class="p">:</span> <span class="n">HybridSearchMode</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">has_hybrid</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Determine whether searches must be hybrid.</span>

<span class="sd">    Args:</span>
<span class="sd">        required_hybrid_search: the hybrid_search parameter required in the constructor.</span>
<span class="sd">        has_hybrid: whether the collection actually is hybrid-capable.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">required_hybrid_search</span> <span class="o">==</span> <span class="n">HybridSearchMode</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">required_hybrid_search</span> <span class="o">==</span> <span class="n">HybridSearchMode</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">has_hybrid</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_hybrid_limits</span><span class="p">(</span>
    <span class="n">hlf</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">hlf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hlf</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hlf</span> <span class="o">*</span> <span class="n">k</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># hlf is a dict:</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">hlk</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hlf</span> <span class="o">*</span> <span class="n">k</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">hlk</span><span class="p">,</span> <span class="n">hlf</span> <span class="ow">in</span> <span class="n">hlf</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_normalize_hybrid_limit_factor</span><span class="p">(</span>
    <span class="n">hybrid_limit_factor</span><span class="p">:</span> <span class="nb">float</span>
    <span class="o">|</span> <span class="kc">None</span>
    <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">HybridLimitFactorPrescription</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Bring `hybrid_limit_factor` to a normal form."""</span>
    <span class="k">if</span> <span class="n">hybrid_limit_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hybrid_limit_factor</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hybrid_limit_factor</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hybrid_limit_factor</span><span class="p">,</span> <span class="n">HybridLimitFactorPrescription</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">VECTOR_FIELD_NAME</span><span class="p">:</span> <span class="n">hybrid_limit_factor</span><span class="o">.</span><span class="n">vector</span><span class="p">,</span>
            <span class="n">LEXICAL_FIELD_NAME</span><span class="p">:</span> <span class="n">hybrid_limit_factor</span><span class="o">.</span><span class="n">lexical</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># already a dict:</span>
    <span class="k">return</span> <span class="n">hybrid_limit_factor</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_insertmany_error_message</span><span class="p">(</span><span class="n">err</span><span class="p">:</span> <span class="n">CollectionInsertManyException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Format an astrapy insert exception into an error message.</span>

<span class="sd">    This utility prepares a detailed message from an astrapy</span>
<span class="sd">    CollectionInsertManyException, to be used in raising an exception within a</span>
<span class="sd">    vectorstore multiple insertion.</span>

<span class="sd">    This operation must filter out duplicate-id specific errors</span>
<span class="sd">    (which the vector store could actually handle, if they were the only ones).</span>
<span class="sd">    """</span>
    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">"Cannot insert documents. The Data API returned the following error(s): "</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_describe_error</span><span class="p">(</span><span class="n">_errd</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_errd</span><span class="p">,</span> <span class="n">DataAPIResponseException</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">edesc</span><span class="o">.</span><span class="n">message</span> <span class="ow">or</span> <span class="s2">""</span>
                <span class="k">for</span> <span class="n">edesc</span> <span class="ow">in</span> <span class="n">_errd</span><span class="o">.</span><span class="n">error_descriptors</span>
                <span class="k">if</span> <span class="n">edesc</span><span class="o">.</span><span class="n">error_code</span> <span class="o">!=</span> <span class="n">DOCUMENT_ALREADY_EXISTS_API_ERROR_CODE</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_errd</span><span class="p">)]</span>

    <span class="n">filtered_error_descs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">edesc</span>
        <span class="k">for</span> <span class="n">insmany_err</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">exceptions</span>
        <span class="k">for</span> <span class="n">edesc</span> <span class="ow">in</span> <span class="n">_describe_error</span><span class="p">(</span><span class="n">insmany_err</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">"; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">edesc</span> <span class="ow">or</span> <span class="s2">""</span> <span class="k">for</span> <span class="n">edesc</span> <span class="ow">in</span> <span class="n">filtered_error_descs</span><span class="p">[:</span><span class="n">MAX_SHOWN_INSERTION_ERRORS</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">num_residual</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_error_descs</span><span class="p">)</span> <span class="o">-</span> <span class="n">MAX_SHOWN_INSERTION_ERRORS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">". (Note: </span><span class="si">{</span><span class="n">num_residual</span><span class="si">}</span><span class="s2"> further errors omitted.)"</span>

    <span class="n">err_msg</span> <span class="o">+=</span> <span class="p">(</span>
        <span class="s2">" (Full API error in '&lt;this-exception&gt;.__cause__.error_descriptors'"</span>
        <span class="sa">f</span><span class="s2">": ignore '</span><span class="si">{</span><span class="n">DOCUMENT_ALREADY_EXISTS_API_ERROR_CODE</span><span class="si">}</span><span class="s2">'.)"</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">err_msg</span>


<div class="viewcode-block" id="AstraDBVectorStoreError">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStoreError.html#langchain_astradb.vectorstores.AstraDBVectorStoreError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AstraDBVectorStoreError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""An exception during vector-store activities.</span>

<span class="sd">    This exception represents any operational exception occurring while</span>
<span class="sd">    performing an action within an AstraDBVectorStore.</span>
<span class="sd">    """</span></div>



<div class="viewcode-block" id="AstraDBVectorStore">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AstraDBVectorStore</span><span class="p">(</span><span class="n">VectorStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A vector store which uses DataStax Astra DB as backend.</span>

<span class="sd">    Setup:</span>
<span class="sd">        Install the ``langchain-astradb`` package and head to the</span>
<span class="sd">        `AstraDB website &lt;https://astra.datastax.com&gt;`_, create an account, create a</span>
<span class="sd">        new database and `create an application token &lt;https://docs.datastax.com/en/astra-db-serverless/administration/manage-application-tokens.html&gt;`_.</span>

<span class="sd">        .. code-block:: bash</span>

<span class="sd">            pip install -qU langchain-astradb</span>

<span class="sd">    Key init args â€” indexing params:</span>
<span class="sd">        collection_name: str</span>
<span class="sd">            Name of the collection.</span>
<span class="sd">        embedding: Embeddings</span>
<span class="sd">            Embedding function to use.</span>

<span class="sd">    Key init args â€” client params:</span>
<span class="sd">        api_endpoint: str</span>
<span class="sd">            Astra DB API endpoint.</span>
<span class="sd">        token: str</span>
<span class="sd">            API token for Astra DB usage.</span>
<span class="sd">        namespace: Optional[str]</span>
<span class="sd">            Namespace (aka keyspace) where the collection is created</span>

<span class="sd">    Instantiate:</span>
<span class="sd">        Get your API endpoint and application token from the dashboard of your database.</span>

<span class="sd">        Create a vector store and provide a LangChain embedding object for working with it:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import getpass</span>

<span class="sd">            from langchain_astradb import AstraDBVectorStore</span>
<span class="sd">            from langchain_openai import OpenAIEmbeddings</span>

<span class="sd">            ASTRA_DB_API_ENDPOINT = getpass.getpass("ASTRA_DB_API_ENDPOINT = ")</span>
<span class="sd">            ASTRA_DB_APPLICATION_TOKEN = getpass.getpass("ASTRA_DB_APPLICATION_TOKEN = ")</span>

<span class="sd">            vector_store = AstraDBVectorStore(</span>
<span class="sd">                collection_name="astra_vector_langchain",</span>
<span class="sd">                embedding=OpenAIEmbeddings(),</span>
<span class="sd">                api_endpoint=ASTRA_DB_API_ENDPOINT,</span>
<span class="sd">                token=ASTRA_DB_APPLICATION_TOKEN,</span>
<span class="sd">            )</span>

<span class="sd">        (Vectorize) Create a vector store where the embedding vector computation happens entirely</span>
<span class="sd">        on the server-side, using the `vectorize &lt;https://docs.datastax.com/en/astra-db-serverless/databases/embedding-generation.html&gt;`_ feature:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import getpass</span>
<span class="sd">            from astrapy.info import VectorServiceOptions</span>

<span class="sd">            from langchain_astradb import AstraDBVectorStore</span>

<span class="sd">            ASTRA_DB_API_ENDPOINT = getpass.getpass("ASTRA_DB_API_ENDPOINT = ")</span>
<span class="sd">            ASTRA_DB_APPLICATION_TOKEN = getpass.getpass("ASTRA_DB_APPLICATION_TOKEN = ")</span>

<span class="sd">            vector_store = AstraDBVectorStore(</span>
<span class="sd">                collection_name="astra_vectorize_langchain",</span>
<span class="sd">                api_endpoint=ASTRA_DB_API_ENDPOINT,</span>
<span class="sd">                token=ASTRA_DB_APPLICATION_TOKEN,</span>
<span class="sd">                collection_vector_service_options=VectorServiceOptions(</span>
<span class="sd">                    provider="nvidia",</span>
<span class="sd">                    model_name="NV-Embed-QA",</span>
<span class="sd">                    # authentication=...,  # needed by some providers/models</span>
<span class="sd">                ),</span>
<span class="sd">            )</span>

<span class="sd">        (Hybrid) The underlying Astra DB typically supports hybrid search</span>
<span class="sd">        (i.e. lexical + vector ANN) to boost the results' accuracy.</span>
<span class="sd">        This is provisioned and used automatically when available. For manual control,</span>
<span class="sd">        use the ``collection_rerank`` and ``collection_lexical`` constructor parameters:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import getpass</span>
<span class="sd">            from astrapy.info import (</span>
<span class="sd">                CollectionLexicalOptions,</span>
<span class="sd">                CollectionRerankOptions,</span>
<span class="sd">                RerankServiceOptions,</span>
<span class="sd">                VectorServiceOptions,</span>
<span class="sd">            )</span>

<span class="sd">            from langchain_astradb import AstraDBVectorStore</span>

<span class="sd">            ASTRA_DB_API_ENDPOINT = getpass.getpass("ASTRA_DB_API_ENDPOINT = ")</span>
<span class="sd">            ASTRA_DB_APPLICATION_TOKEN = getpass.getpass("ASTRA_DB_APPLICATION_TOKEN = ")</span>

<span class="sd">            vector_store = AstraDBVectorStore(</span>
<span class="sd">                collection_name="astra_vectorize_langchain",</span>
<span class="sd">                # embedding=...,  # needed unless using 'vectorize'</span>
<span class="sd">                api_endpoint=ASTRA_DB_API_ENDPOINT,</span>
<span class="sd">                token=ASTRA_DB_APPLICATION_TOKEN,</span>
<span class="sd">                collection_vector_service_options=VectorServiceOptions(...),  # see above</span>
<span class="sd">                collection_lexical=CollectionLexicalOptions(analyzer="standard"),</span>
<span class="sd">                collection_rerank=CollectionRerankOptions(</span>
<span class="sd">                    service=RerankServiceOptions(</span>
<span class="sd">                        provider="nvidia",</span>
<span class="sd">                        model_name="nvidia/llama-3.2-nv-rerankqa-1b-v2",</span>
<span class="sd">                    ),</span>
<span class="sd">                ),</span>
<span class="sd">                collection_reranking_api_key=...,  # if needed by the model/setup</span>
<span class="sd">            )</span>

<span class="sd">        Hybrid-related server upgrades may introduce a mismatch between the store</span>
<span class="sd">        defaults and a pre-existing collection: in case one such mismatch is</span>
<span class="sd">        reported (as a Data API "EXISTING_COLLECTION_DIFFERENT_SETTINGS" error),</span>
<span class="sd">        the options to resolve are:</span>
<span class="sd">        (1) use autodetect mode, (2) switch to ``setup_mode`` "OFF", or</span>
<span class="sd">        (3) explicitly specify lexical and/or rerank settings in the vector</span>
<span class="sd">        store constructor, to match the existing collection configuration.</span>
<span class="sd">        See `here &lt;https://github.com/langchain-ai/langchain-datastax/blob/main/libs/astradb/README.md#collection-defaults-mismatch&gt;`_ for more details.</span>

<span class="sd">        (Autodetect) Let the vector store figure out the configuration (including vectorize</span>
<span class="sd">        and document encoding scheme on DB), by inspection of an existing collection:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import getpass</span>

<span class="sd">            from langchain_astradb import AstraDBVectorStore</span>

<span class="sd">            ASTRA_DB_API_ENDPOINT = getpass.getpass("ASTRA_DB_API_ENDPOINT = ")</span>
<span class="sd">            ASTRA_DB_APPLICATION_TOKEN = getpass.getpass("ASTRA_DB_APPLICATION_TOKEN = ")</span>

<span class="sd">            vector_store = AstraDBVectorStore(</span>
<span class="sd">                collection_name="astra_existing_collection",</span>
<span class="sd">                # embedding=...,  # needed unless using 'vectorize'</span>
<span class="sd">                api_endpoint=ASTRA_DB_API_ENDPOINT,</span>
<span class="sd">                token=ASTRA_DB_APPLICATION_TOKEN,</span>
<span class="sd">                autodetect_collection=True,</span>
<span class="sd">            )</span>

<span class="sd">        (Non-Astra DB) This class can also target a non-Astra DB database, such as a</span>
<span class="sd">        self-deployed HCD, through the Data API:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import getpass</span>

<span class="sd">            from astrapy.authentication import UsernamePasswordTokenProvider</span>

<span class="sd">            from langchain_astradb import AstraDBVectorStore</span>

<span class="sd">            vector_store = AstraDBVectorStore(</span>
<span class="sd">                collection_name="astra_existing_collection",</span>
<span class="sd">                # embedding=...,  # needed unless using 'vectorize'</span>
<span class="sd">                api_endpoint="http://localhost:8181",</span>
<span class="sd">                token=UsernamePasswordTokenProvider(</span>
<span class="sd">                    username="user",</span>
<span class="sd">                    password="pwd",</span>
<span class="sd">                ),</span>
<span class="sd">                collection_vector_service_options=...,  # if 'vectorize'</span>
<span class="sd">            )</span>

<span class="sd">    Add Documents:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            from langchain_core.documents import Document</span>

<span class="sd">            document_1 = Document(page_content="foo", metadata={"baz": "bar"})</span>
<span class="sd">            document_2 = Document(page_content="thud", metadata={"bar": "baz"})</span>
<span class="sd">            document_3 = Document(page_content="i will be deleted :(")</span>

<span class="sd">            documents = [document_1, document_2, document_3]</span>
<span class="sd">            ids = ["1", "2", "3"]</span>
<span class="sd">            vector_store.add_documents(documents=documents, ids=ids)</span>

<span class="sd">    Delete Documents:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            vector_store.delete(ids=["3"])</span>

<span class="sd">    Search:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = vector_store.similarity_search(query="thud",k=1)</span>
<span class="sd">            for doc in results:</span>
<span class="sd">                print(f"* {doc.page_content} [{doc.metadata}]")</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            thud [{'bar': 'baz'}]</span>

<span class="sd">    Search with filter:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = vector_store.similarity_search(query="thud",k=1,filter={"bar": "baz"})</span>
<span class="sd">            for doc in results:</span>
<span class="sd">                print(f"* {doc.page_content} [{doc.metadata}]")</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            thud [{'bar': 'baz'}]</span>

<span class="sd">    Search with score:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = vector_store.similarity_search_with_score(query="qux",k=1)</span>
<span class="sd">            for doc, score in results:</span>
<span class="sd">                print(f"* [SIM={score:3f}] {doc.page_content} [{doc.metadata}]")</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            [SIM=0.916135] foo [{'baz': 'bar'}]</span>

<span class="sd">    Async:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            # add documents</span>
<span class="sd">            await vector_store.aadd_documents(documents=documents, ids=ids)</span>

<span class="sd">            # delete documents</span>
<span class="sd">            await vector_store.adelete(ids=["3"])</span>

<span class="sd">            # search</span>
<span class="sd">            results = vector_store.asimilarity_search(query="thud",k=1)</span>

<span class="sd">            # search with score</span>
<span class="sd">            results = await vector_store.asimilarity_search_with_score(query="qux",k=1)</span>
<span class="sd">            for doc,score in results:</span>
<span class="sd">                print(f"* [SIM={score:3f}] {doc.page_content} [{doc.metadata}]")</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            [SIM=0.916135] foo [{'baz': 'bar'}]</span>

<span class="sd">    Use as Retriever:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            retriever = vector_store.as_retriever(</span>
<span class="sd">                search_type="similarity_score_threshold",</span>
<span class="sd">                search_kwargs={"k": 1, "score_threshold": 0.5},</span>
<span class="sd">            )</span>
<span class="sd">            retriever.invoke("thud")</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            [Document(metadata={'bar': 'baz'}, page_content='thud')]</span>

<span class="sd">    """</span>  <span class="c1"># noqa: E501</span>

<div class="viewcode-block" id="AstraDBVectorStore.filter_to_query">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.filter_to_query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_to_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Prepare a query for use on DB based on metadata filter.</span>

<span class="sd">        Encode an "abstract" filter clause on metadata into a query filter</span>
<span class="sd">        condition aware of the collection schema choice.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_dict: a metadata condition in the form {"field": "value"}</span>
<span class="sd">                or related.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the corresponding mapping ready for use in queries,</span>
<span class="sd">            aware of the details of the schema used to encode the document on DB.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">filter_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_filter</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_metadata_indexing_policy</span><span class="p">(</span>
        <span class="n">metadata_indexing_include</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata_indexing_exclude</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_indexing_policy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">document_codec</span><span class="p">:</span> <span class="n">_AstraDBVectorStoreDocumentCodec</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Normalize the constructor indexing parameters.</span>

<span class="sd">        Validate the constructor indexing parameters and normalize them</span>
<span class="sd">        into a ready-to-use dict for the 'options' when creating a collection.</span>
<span class="sd">        """</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">metadata_indexing_include</span><span class="p">,</span>
            <span class="n">metadata_indexing_exclude</span><span class="p">,</span>
            <span class="n">collection_indexing_policy</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"At most one of the parameters `metadata_indexing_include`,"</span>
                <span class="s2">" `metadata_indexing_exclude` and `collection_indexing_policy`"</span>
                <span class="s2">" can be specified as non null."</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata_indexing_include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">"allow"</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">document_codec</span><span class="o">.</span><span class="n">metadata_key_to_field_identifier</span><span class="p">(</span><span class="n">md_field</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">md_field</span> <span class="ow">in</span> <span class="n">metadata_indexing_include</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">metadata_indexing_exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">"deny"</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">document_codec</span><span class="o">.</span><span class="n">metadata_key_to_field_identifier</span><span class="p">(</span><span class="n">md_field</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">md_field</span> <span class="ow">in</span> <span class="n">metadata_indexing_exclude</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">collection_indexing_policy</span>
            <span class="k">if</span> <span class="n">collection_indexing_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">document_codec</span><span class="o">.</span><span class="n">default_collection_indexing_policy</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AstraDBVectorStore.__init__">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">TokenProvider</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">api_endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bulk_insert_batch_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bulk_insert_overwrite_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bulk_delete_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">setup_mode</span><span class="p">:</span> <span class="n">SetupMode</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">metadata_indexing_include</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata_indexing_exclude</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_indexing_policy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_vector_service_options</span><span class="p">:</span> <span class="n">VectorServiceOptions</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_embedding_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">EmbeddingHeadersProvider</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_invalid_documents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">autodetect_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ext_callers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">COMPONENT_NAME_VECTORSTORE</span><span class="p">,</span>
        <span class="n">api_options</span><span class="p">:</span> <span class="n">APIOptions</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_rerank</span><span class="p">:</span> <span class="n">CollectionRerankOptions</span> <span class="o">|</span> <span class="n">RerankServiceOptions</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_reranking_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">RerankingHeadersProvider</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_lexical</span><span class="p">:</span> <span class="nb">str</span>
        <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">CollectionLexicalOptions</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hybrid_search</span><span class="p">:</span> <span class="n">HybridSearchMode</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hybrid_limit_factor</span><span class="p">:</span> <span class="nb">float</span>
        <span class="o">|</span> <span class="kc">None</span>
        <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">HybridLimitFactorPrescription</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A vector store which uses DataStax Astra DB as backend.</span>

<span class="sd">        For more on Astra DB, visit</span>
<span class="sd">        https://docs.datastax.com/en/astra-db-serverless/index.html</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: the embeddings function or service to use.</span>
<span class="sd">                This enables client-side embedding functions or calls to external</span>
<span class="sd">                embedding providers. If ``embedding`` is passed, then</span>
<span class="sd">                ``collection_vector_service_options`` can not be provided.</span>
<span class="sd">            collection_name: name of the Astra DB collection to create/use.</span>
<span class="sd">            token: API token for Astra DB usage, either in the form of a string</span>
<span class="sd">                or a subclass of ``astrapy.authentication.TokenProvider``.</span>
<span class="sd">                If not provided, the environment variable</span>
<span class="sd">                ASTRA_DB_APPLICATION_TOKEN is inspected.</span>
<span class="sd">            api_endpoint: full URL to the API endpoint, such as</span>
<span class="sd">                ``https://&lt;DB-ID&gt;-us-east1.apps.astra.datastax.com``. If not provided,</span>
<span class="sd">                the environment variable ASTRA_DB_API_ENDPOINT is inspected.</span>
<span class="sd">            environment: a string specifying the environment of the target Data API.</span>
<span class="sd">                If omitted, defaults to "prod" (Astra DB production).</span>
<span class="sd">                Other values are in ``astrapy.constants.Environment`` enum class.</span>
<span class="sd">            namespace: namespace (aka keyspace) where the collection is created.</span>
<span class="sd">                If not provided, the environment variable ASTRA_DB_KEYSPACE is</span>
<span class="sd">                inspected. Defaults to the database's "default namespace".</span>
<span class="sd">            metric: similarity function to use out of those available in Astra DB.</span>
<span class="sd">                If left out, it will use Astra DB API's defaults (i.e. "cosine" - but,</span>
<span class="sd">                for performance reasons, "dot_product" is suggested if embeddings are</span>
<span class="sd">                normalized to one).</span>
<span class="sd">            batch_size: Size of document chunks for each individual insertion</span>
<span class="sd">                API request. If not provided, astrapy defaults are applied.</span>
<span class="sd">            bulk_insert_batch_concurrency: Number of threads or coroutines to insert</span>
<span class="sd">                batches concurrently.</span>
<span class="sd">            bulk_insert_overwrite_concurrency: Number of threads or coroutines in a</span>
<span class="sd">                batch to insert pre-existing entries.</span>
<span class="sd">            bulk_delete_concurrency: Number of threads or coroutines for</span>
<span class="sd">                multiple-entry deletes.</span>
<span class="sd">            setup_mode: mode used to create the collection (SYNC, ASYNC or OFF).</span>
<span class="sd">            pre_delete_collection: whether to delete the collection before creating it.</span>
<span class="sd">                If False and the collection already exists, the collection will be used</span>
<span class="sd">                as is.</span>
<span class="sd">            metadata_indexing_include: an allowlist of the specific metadata subfields</span>
<span class="sd">                that should be indexed for later filtering in searches.</span>
<span class="sd">            metadata_indexing_exclude: a denylist of the specific metadata subfields</span>
<span class="sd">                that should not be indexed for later filtering in searches.</span>
<span class="sd">            collection_indexing_policy: a full "indexing" specification for</span>
<span class="sd">                what fields should be indexed for later filtering in searches.</span>
<span class="sd">                This dict must conform to to the API specifications</span>
<span class="sd">                (see https://docs.datastax.com/en/astra-db-serverless/api-reference/collections.html#the-indexing-option)</span>
<span class="sd">            collection_vector_service_options: specifies the use of server-side</span>
<span class="sd">                embeddings within Astra DB. If passing this parameter, ``embedding``</span>
<span class="sd">                cannot be provided.</span>
<span class="sd">            collection_embedding_api_key: for usage of server-side embeddings</span>
<span class="sd">                within Astra DB. With this parameter one can supply an API Key</span>
<span class="sd">                that will be passed to Astra DB with each data request.</span>
<span class="sd">                This parameter can be either a string or a subclass of</span>
<span class="sd">                ``astrapy.authentication.EmbeddingHeadersProvider``.</span>
<span class="sd">                This is useful when the service is configured for the collection,</span>
<span class="sd">                but no corresponding secret is stored within</span>
<span class="sd">                Astra's key management system.</span>
<span class="sd">            content_field: name of the field containing the textual content</span>
<span class="sd">                in the documents when saved on Astra DB. For vectorize collections,</span>
<span class="sd">                this cannot be specified; for non-vectorize collection, defaults</span>
<span class="sd">                to "content".</span>
<span class="sd">                The special value "*" can be passed only if autodetect_collection=True.</span>
<span class="sd">                In this case, the actual name of the key for the textual content is</span>
<span class="sd">                guessed by inspection of a few documents from the collection, under the</span>
<span class="sd">                assumption that the longer strings are the most likely candidates.</span>
<span class="sd">                Please understand the limitations of this method and get some</span>
<span class="sd">                understanding of your data before passing ``"*"`` for this parameter.</span>
<span class="sd">            ignore_invalid_documents: if False (default), exceptions are raised</span>
<span class="sd">                when a document is found on the Astra DB collection that does</span>
<span class="sd">                not have the expected shape. If set to True, such results</span>
<span class="sd">                from the database are ignored and a warning is issued. Note</span>
<span class="sd">                that in this case a similarity search may end up returning fewer</span>
<span class="sd">                results than the required ``k``.</span>
<span class="sd">            autodetect_collection: if True, turns on autodetect behavior.</span>
<span class="sd">                The store will look for an existing collection of the provided name</span>
<span class="sd">                and infer the store settings from it. Default is False.</span>
<span class="sd">                In autodetect mode, ``content_field`` can be given as ``"*"``, meaning</span>
<span class="sd">                that an attempt will be made to determine it by inspection (unless</span>
<span class="sd">                vectorize is enabled, in which case ``content_field`` is ignored).</span>
<span class="sd">                In autodetect mode, the store not only determines whether embeddings</span>
<span class="sd">                are client- or server-side, but - most importantly - switches</span>
<span class="sd">                automatically between "nested" and "flat" representations of documents</span>
<span class="sd">                on DB (i.e. having the metadata key-value pairs grouped in a</span>
<span class="sd">                ``metadata`` field or spread at the documents' top-level). The former</span>
<span class="sd">                scheme is the native mode of the AstraDBVectorStore; the store resorts</span>
<span class="sd">                to the latter in case of vector collections populated with external</span>
<span class="sd">                means (such as a third-party data import tool) before applying</span>
<span class="sd">                an AstraDBVectorStore to them.</span>
<span class="sd">                Note that the following parameters cannot be used if this is True:</span>
<span class="sd">                ``metric``, ``setup_mode``, ``metadata_indexing_include``,</span>
<span class="sd">                ``metadata_indexing_exclude``, ``collection_indexing_policy``,</span>
<span class="sd">                ``collection_vector_service_options``.</span>
<span class="sd">            ext_callers: one or more caller identities to identify Data API calls</span>
<span class="sd">                in the User-Agent header. This is a list of (name, version) pairs,</span>
<span class="sd">                or just strings if no version info is provided, which, if supplied,</span>
<span class="sd">                becomes the leading part of the User-Agent string in all API requests</span>
<span class="sd">                related to this component.</span>
<span class="sd">            component_name: the string identifying this specific component in the</span>
<span class="sd">                stack of usage info passed as the User-Agent string to the Data API.</span>
<span class="sd">                Defaults to "langchain_vectorstore", but can be overridden if this</span>
<span class="sd">                component actually serves as the building block for another component</span>
<span class="sd">                (such as when the vector store is used within a ``GraphRetriever``).</span>
<span class="sd">            api_options: an instance of ``astrapy.utils.api_options.APIOptions`` that</span>
<span class="sd">                can be supplied to customize the interaction with the Data API</span>
<span class="sd">                regarding serialization/deserialization, timeouts, custom headers</span>
<span class="sd">                and so on. The provided options are applied on top of settings already</span>
<span class="sd">                tailored to this library, and if specified will take precedence.</span>
<span class="sd">                Passing None (default) means no customization is requested.</span>
<span class="sd">                Refer to the astrapy documentation for details.</span>
<span class="sd">            collection_rerank: providing reranking settings is necessary to run</span>
<span class="sd">                hybrid searches for similarity. This parameter can be an instance</span>
<span class="sd">                of the astrapy classes `CollectionRerankOptions` or</span>
<span class="sd">                ``RerankServiceOptions``.</span>
<span class="sd">            collection_reranking_api_key: for usage of server-side reranking services</span>
<span class="sd">                within Astra DB. With this parameter one can supply an API Key</span>
<span class="sd">                that will be passed to Astra DB with each data request.</span>
<span class="sd">                This parameter can be either a string or a subclass of</span>
<span class="sd">                ``astrapy.authentication.RerankingHeadersProvider``.</span>
<span class="sd">                This is useful when the service is configured for the collection,</span>
<span class="sd">                but no corresponding secret is stored within</span>
<span class="sd">                Astra's key management system.</span>
<span class="sd">            collection_lexical: configuring a lexical analyzer is necessary to run</span>
<span class="sd">                lexical and hybrid searches. This parameter can be a string or dict,</span>
<span class="sd">                which is then passed as-is for the "analyzer" field of a</span>
<span class="sd">                createCollection's "$lexical.analyzer" value, or a ready-made</span>
<span class="sd">                astrapy `CollectionLexicalOptions` object.</span>
<span class="sd">            hybrid_search: whether similarity searches should be run as Hybrid searches</span>
<span class="sd">                or not. Values are DEFAULT, ON or OFF. In case of DEFAULT, searches</span>
<span class="sd">                are performed as permitted by the collection configuration, with a</span>
<span class="sd">                preference for hybrid search. Forcing this setting to ON for a</span>
<span class="sd">                non-hybrid-enabled collection would result in a server error when</span>
<span class="sd">                running searches.</span>
<span class="sd">            hybrid_limit_factor: subsearch "limit" specification for hybrid searches.</span>
<span class="sd">                If omitted, hybrid searches do not specify it and leave the Data API</span>
<span class="sd">                to use its defaults.</span>
<span class="sd">                If a floating-point positive number is provided: each subsearch</span>
<span class="sd">                participating in the hybrid search (i.e. both the vector-based ANN</span>
<span class="sd">                and the lexical-based) will be requested to fecth up to</span>
<span class="sd">                `int(k*hybrid_limit_factor)` items, where `k` is the desired result</span>
<span class="sd">                count from the whole search.</span>
<span class="sd">                If a `HybridLimitFactorPrescription` is provided (see the class</span>
<span class="sd">                docstring for details), separate factors are applied to the vector</span>
<span class="sd">                and the lexical subsearches. Alternatively, a simple dictionary</span>
<span class="sd">                with keys "$lexical" and "$vector" achieves the same effect.</span>

<span class="sd">        Note:</span>
<span class="sd">            For concurrency in synchronous :meth:`~add_texts`:, as a rule of thumb,</span>
<span class="sd">            on a typical client machine it is suggested to keep the quantity</span>
<span class="sd">            bulk_insert_batch_concurrency * bulk_insert_overwrite_concurrency</span>
<span class="sd">            much below 1000 to avoid exhausting the client multithreading/networking</span>
<span class="sd">            resources. The hardcoded defaults are somewhat conservative to meet</span>
<span class="sd">            most machines' specs, but a sensible choice to test may be:</span>

<span class="sd">            - bulk_insert_batch_concurrency = 80</span>
<span class="sd">            - bulk_insert_overwrite_concurrency = 10</span>

<span class="sd">            A bit of experimentation is required to nail the best results here,</span>
<span class="sd">            depending on both the machine/network specs and the expected workload</span>
<span class="sd">            (specifically, how often a write is an update of an existing id).</span>
<span class="sd">            Remember you can pass concurrency settings to individual calls to</span>
<span class="sd">            :meth:`~add_texts` and :meth:`~add_documents` as well.</span>
<span class="sd">        """</span>
        <span class="c1"># general collection settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="n">api_endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexing_policy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autodetect_collection</span> <span class="o">=</span> <span class="n">autodetect_collection</span>
        <span class="c1"># vector-related settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_embedding_api_key</span> <span class="o">=</span> <span class="n">collection_embedding_api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span> <span class="o">=</span> <span class="n">collection_vector_service_options</span>
        <span class="c1"># DB-encoding settings:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="p">:</span> <span class="n">_AstraDBVectorStoreDocumentCodec</span>
        <span class="c1"># concurrency settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="ow">or</span> <span class="n">DEFAULT_DOCUMENT_CHUNK_SIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_batch_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bulk_insert_batch_concurrency</span> <span class="ow">or</span> <span class="n">MAX_CONCURRENT_DOCUMENT_INSERTIONS</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bulk_insert_overwrite_concurrency</span> <span class="ow">or</span> <span class="n">MAX_CONCURRENT_DOCUMENT_REPLACEMENTS</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_delete_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bulk_delete_concurrency</span> <span class="ow">or</span> <span class="n">MAX_CONCURRENT_DOCUMENT_DELETIONS</span>
        <span class="p">)</span>

        <span class="n">_setup_mode</span><span class="p">:</span> <span class="n">SetupMode</span>
        <span class="n">_embedding_dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_hybrid</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1"># affecting the actual behaviour when running searches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_limit_factor</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_reranking_api_key</span> <span class="o">=</span> <span class="n">collection_reranking_api_key</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autodetect_collection</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"vector store default init, collection '</span><span class="si">%s</span><span class="s2">'"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span>
            <span class="p">)</span>
            <span class="n">_setup_mode</span> <span class="o">=</span> <span class="n">SetupMode</span><span class="o">.</span><span class="n">SYNC</span> <span class="k">if</span> <span class="n">setup_mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">setup_mode</span>
            <span class="n">_embedding_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_embedding_dimension</span><span class="p">(</span><span class="n">_setup_mode</span><span class="p">)</span>
            <span class="c1"># determine vectorize/nonvectorize</span>
            <span class="n">has_vectorize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">_content_field</span> <span class="o">=</span> <span class="n">_normalize_content_field</span><span class="p">(</span>
                <span class="n">content_field</span><span class="p">,</span>
                <span class="n">is_autodetect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">has_vectorize</span><span class="o">=</span><span class="n">has_vectorize</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">collection_lexical</span><span class="o">.</span><span class="n">enabled</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_lexical</span><span class="p">,</span> <span class="n">CollectionLexicalOptions</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">collection_lexical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">_has_reranking</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">collection_rerank</span><span class="o">.</span><span class="n">enabled</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection_rerank</span><span class="p">,</span> <span class="n">CollectionRerankOptions</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">collection_rerank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_hybrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span> <span class="ow">and</span> <span class="n">_has_reranking</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span> <span class="o">=</span> <span class="n">_decide_hybrid_search_setting</span><span class="p">(</span>
                <span class="n">required_hybrid_search</span><span class="o">=</span><span class="n">hybrid_search</span><span class="p">,</span>
                <span class="n">has_hybrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_hybrid</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span> <span class="o">=</span> <span class="n">_DefaultVectorizeVSDocumentCodec</span><span class="p">(</span>
                    <span class="n">ignore_invalid_documents</span><span class="o">=</span><span class="n">ignore_invalid_documents</span><span class="p">,</span>
                    <span class="n">has_lexical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span> <span class="o">=</span> <span class="n">_DefaultVSDocumentCodec</span><span class="p">(</span>
                    <span class="n">content_field</span><span class="o">=</span><span class="n">_content_field</span><span class="p">,</span>
                    <span class="n">ignore_invalid_documents</span><span class="o">=</span><span class="n">ignore_invalid_documents</span><span class="p">,</span>
                    <span class="n">has_lexical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># indexing policy setting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexing_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_metadata_indexing_policy</span><span class="p">(</span>
                <span class="n">metadata_indexing_include</span><span class="o">=</span><span class="n">metadata_indexing_include</span><span class="p">,</span>
                <span class="n">metadata_indexing_exclude</span><span class="o">=</span><span class="n">metadata_indexing_exclude</span><span class="p">,</span>
                <span class="n">collection_indexing_policy</span><span class="o">=</span><span class="n">collection_indexing_policy</span><span class="p">,</span>
                <span class="n">document_codec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"vector store autodetect init, collection '</span><span class="si">%s</span><span class="s2">'"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span>
            <span class="p">)</span>
            <span class="c1"># specific checks for autodetect logic</span>
            <span class="n">_validate_autodetect_init_params</span><span class="p">(</span>
                <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
                <span class="n">setup_mode</span><span class="o">=</span><span class="n">setup_mode</span><span class="p">,</span>
                <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
                <span class="n">metadata_indexing_include</span><span class="o">=</span><span class="n">metadata_indexing_include</span><span class="p">,</span>
                <span class="n">metadata_indexing_exclude</span><span class="o">=</span><span class="n">metadata_indexing_exclude</span><span class="p">,</span>
                <span class="n">collection_indexing_policy</span><span class="o">=</span><span class="n">collection_indexing_policy</span><span class="p">,</span>
                <span class="n">collection_vector_service_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span><span class="p">,</span>
                <span class="n">collection_lexical</span><span class="o">=</span><span class="n">collection_lexical</span><span class="p">,</span>
                <span class="n">collection_rerank</span><span class="o">=</span><span class="n">collection_rerank</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_setup_mode</span> <span class="o">=</span> <span class="n">SetupMode</span><span class="o">.</span><span class="n">OFF</span>

            <span class="c1"># fetch collection intelligence</span>
            <span class="n">c_descriptor</span><span class="p">,</span> <span class="n">c_documents</span> <span class="o">=</span> <span class="n">_survey_collection</span><span class="p">(</span>
                <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
                <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                <span class="n">api_endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_endpoint</span><span class="p">,</span>
                <span class="n">keyspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span>
                <span class="n">ext_callers</span><span class="o">=</span><span class="n">ext_callers</span><span class="p">,</span>
                <span class="n">component_name</span><span class="o">=</span><span class="n">component_name</span><span class="p">,</span>
                <span class="n">api_options</span><span class="o">=</span><span class="n">api_options</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">c_descriptor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Collection '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">' not found."</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1"># use the collection info to set the store properties</span>
            <span class="n">c_vector_options</span> <span class="o">=</span> <span class="n">c_descriptor</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"vector"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c_vector_options</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Non-vector collection detected."</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">_embedding_dimension</span> <span class="o">=</span> <span class="n">c_vector_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dimension"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span> <span class="o">=</span> <span class="n">c_vector_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"service"</span><span class="p">)</span>
            <span class="n">has_vectorize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"vector store autodetect: has_vectorize = </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">has_vectorize</span><span class="p">)</span>
            <span class="n">norm_content_field</span> <span class="o">=</span> <span class="n">_normalize_content_field</span><span class="p">(</span>
                <span class="n">content_field</span><span class="p">,</span>
                <span class="n">is_autodetect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">has_vectorize</span><span class="o">=</span><span class="n">has_vectorize</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">c_descriptor</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">lexical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">c_descriptor</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">lexical</span><span class="o">.</span><span class="n">enabled</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span> <span class="o">=</span> <span class="n">_detect_document_codec</span><span class="p">(</span>
                <span class="n">c_documents</span><span class="p">,</span>
                <span class="n">has_vectorize</span><span class="o">=</span><span class="n">has_vectorize</span><span class="p">,</span>
                <span class="n">has_lexical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span><span class="p">,</span>
                <span class="n">ignore_invalid_documents</span><span class="o">=</span><span class="n">ignore_invalid_documents</span><span class="p">,</span>
                <span class="n">norm_content_field</span><span class="o">=</span><span class="n">norm_content_field</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexing_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_metadata_indexing_policy</span><span class="p">(</span>
                <span class="n">metadata_indexing_include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">metadata_indexing_exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">collection_indexing_policy</span><span class="o">=</span><span class="n">c_descriptor</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">indexing</span><span class="p">,</span>
                <span class="n">document_codec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">_has_reranking</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">c_descriptor</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">rerank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">c_descriptor</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">rerank</span><span class="o">.</span><span class="n">enabled</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_hybrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span> <span class="ow">and</span> <span class="n">_has_reranking</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span> <span class="o">=</span> <span class="n">_decide_hybrid_search_setting</span><span class="p">(</span>
                <span class="n">required_hybrid_search</span><span class="o">=</span><span class="n">hybrid_search</span><span class="p">,</span>
                <span class="n">has_hybrid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_hybrid</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># validate embedding/vectorize compatibility and such.</span>
        <span class="c1"># Embedding and the server-side embeddings are mutually exclusive,</span>
        <span class="c1"># as both specify how to produce embeddings.</span>
        <span class="c1"># Also API key makes no sense unless vectorize.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Embedding is required for non-vectorize collections."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Embedding cannot be provided for vectorize collections."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_limit_factor</span> <span class="o">=</span> <span class="n">_normalize_hybrid_limit_factor</span><span class="p">(</span><span class="n">hybrid_limit_factor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span> <span class="o">=</span> <span class="n">_AstraDBCollectionEnvironment</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
            <span class="n">api_endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_endpoint</span><span class="p">,</span>
            <span class="n">keyspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span>
            <span class="n">setup_mode</span><span class="o">=</span><span class="n">_setup_mode</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">embedding_dimension</span><span class="o">=</span><span class="n">_embedding_dimension</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">requested_indexing_policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexing_policy</span><span class="p">,</span>
            <span class="n">default_indexing_policy</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">default_collection_indexing_policy</span>
            <span class="p">),</span>
            <span class="n">collection_vector_service_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span><span class="p">,</span>
            <span class="n">collection_embedding_api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_embedding_api_key</span><span class="p">,</span>
            <span class="n">ext_callers</span><span class="o">=</span><span class="n">ext_callers</span><span class="p">,</span>
            <span class="n">component_name</span><span class="o">=</span><span class="n">component_name</span><span class="p">,</span>
            <span class="n">api_options</span><span class="o">=</span><span class="n">api_options</span><span class="p">,</span>
            <span class="n">collection_rerank</span><span class="o">=</span><span class="n">collection_rerank</span><span class="p">,</span>
            <span class="n">collection_reranking_api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_reranking_api_key</span><span class="p">,</span>
            <span class="n">collection_lexical</span><span class="o">=</span><span class="n">collection_lexical</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_safe_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Embeddings</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Missing embedding"</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_embedding_dimension</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">setup_mode</span><span class="p">:</span> <span class="n">SetupMode</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the right kind of object for the astra_env to use."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">SetupMode</span><span class="o">.</span><span class="n">ASYNC</span><span class="p">:</span>
            <span class="c1"># in this case, we wrap the computation as an awaitable</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_aget_embedding_dimension</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">aembed_query</span><span class="p">(</span>
                            <span class="n">text</span><span class="o">=</span><span class="s2">"This is a sample sentence."</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span>

            <span class="k">return</span> <span class="n">_aget_embedding_dimension</span><span class="p">()</span>
        <span class="c1"># case of setup_mode = SetupMode.SYNC, SetupMode.OFF</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span>
                    <span class="n">text</span><span class="o">=</span><span class="s2">"This is a sample sentence."</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span>

    <span class="nd">@property</span>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Embeddings</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Accesses the supplied embeddings object.</span>

<span class="sd">        If using server-side embeddings, this will return None.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_select_relevance_score_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># The underlying API calls already returns a "score proper",</span>
        <span class="c1"># i.e. one in [0, 1] where higher means more *similar*,</span>
        <span class="c1"># so here the final score transformation is not reversing the interval.</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">score</span><span class="p">:</span> <span class="n">score</span>

<div class="viewcode-block" id="AstraDBVectorStore.copy">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">TokenProvider</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ext_callers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_embedding_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">EmbeddingHeadersProvider</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_reranking_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">RerankingHeadersProvider</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBVectorStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a copy, possibly with changed attributes.</span>

<span class="sd">        This method creates a shallow copy of this environment. If a parameter</span>
<span class="sd">        is passed and differs from None, it will replace the corresponding value</span>
<span class="sd">        in the copy.</span>

<span class="sd">        The method allows changing only the parameters that ensure the copy is</span>
<span class="sd">        functional and does not trigger side-effects:</span>
<span class="sd">        for example, one cannot create a copy acting on a new collection.</span>
<span class="sd">        In those cases, one should create a new instance of ``AstraDBVectorStore``</span>
<span class="sd">        from scratch.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            token: API token for Astra DB usage, either in the form of a string</span>
<span class="sd">                or a subclass of ``astrapy.authentication.TokenProvider``.</span>
<span class="sd">                In order to suppress token usage in the copy, explicitly pass</span>
<span class="sd">                ``astrapy.authentication.StaticTokenProvider(None)``.</span>
<span class="sd">            ext_callers: additional custom (caller_name, caller_version) pairs</span>
<span class="sd">                to attach to the User-Agent header when issuing Data API requests.</span>
<span class="sd">            component_name: a value for the LangChain component name to use when</span>
<span class="sd">                identifying the originator of the Data API requests.</span>
<span class="sd">            collection_embedding_api_key: the API Key to supply in each Data API</span>
<span class="sd">                request if necessary. This is necessary if using the Vectorize</span>
<span class="sd">                feature and no secret is stored with the database.</span>
<span class="sd">                In order to suppress the API Key in the copy, explicitly pass</span>
<span class="sd">                ``astrapy.authentication.EmbeddingAPIKeyHeaderProvider(None)``.</span>
<span class="sd">            collection_reranking_api_key: for usage of server-side reranking services</span>
<span class="sd">                within Astra DB. With this parameter one can supply an API Key</span>
<span class="sd">                that will be passed to Astra DB with each data request.</span>
<span class="sd">                This parameter can be either a string or a subclass of</span>
<span class="sd">                ``astrapy.authentication.RerankingHeadersProvider``.</span>
<span class="sd">                This is useful when the service is configured for the collection,</span>
<span class="sd">                but no corresponding secret is stored within</span>
<span class="sd">                Astra's key management system.</span>
<span class="sd">        """</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="n">AstraDBVectorStore</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="s2">"moot"</span><span class="p">,</span>
            <span class="n">api_endpoint</span><span class="o">=</span><span class="s2">"http://moot"</span><span class="p">,</span>
            <span class="n">environment</span><span class="o">=</span><span class="n">Environment</span><span class="o">.</span><span class="n">OTHER</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="s2">"moot"</span><span class="p">,</span>
            <span class="n">setup_mode</span><span class="o">=</span><span class="n">SetupMode</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span>
            <span class="n">collection_vector_service_options</span><span class="o">=</span><span class="n">VectorServiceOptions</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">=</span><span class="s2">"moot"</span><span class="p">,</span>
                <span class="n">model_name</span><span class="o">=</span><span class="s2">"moot"</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">token</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_endpoint</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">indexing_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexing_policy</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">autodetect_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autodetect_collection</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">embedding_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">collection_embedding_api_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_embedding_api_key</span>
            <span class="k">if</span> <span class="n">collection_embedding_api_key</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">collection_embedding_api_key</span>
        <span class="p">)</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">collection_reranking_api_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_reranking_api_key</span>
            <span class="k">if</span> <span class="n">collection_reranking_api_key</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">collection_reranking_api_key</span>
        <span class="p">)</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">collection_vector_service_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_vector_service_options</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">document_codec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">has_lexical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lexical</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">has_hybrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">hybrid_limit_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_limit_factor</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">bulk_insert_batch_concurrency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_batch_concurrency</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">bulk_delete_concurrency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_delete_concurrency</span>
        <span class="c1"># Now the .astra_env attribute:</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">astra_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">ext_callers</span><span class="o">=</span><span class="n">ext_callers</span><span class="p">,</span>
            <span class="n">component_name</span><span class="o">=</span><span class="n">component_name</span><span class="p">,</span>
            <span class="n">collection_embedding_api_key</span><span class="o">=</span><span class="n">collection_embedding_api_key</span><span class="p">,</span>
            <span class="n">collection_reranking_api_key</span><span class="o">=</span><span class="n">collection_reranking_api_key</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">copy</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.clear">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.clear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Empty the collection of all its stored entries."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.aclear">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.aclear">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Empty the collection of all its stored entries."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.delete_by_document_id">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.delete_by_document_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Remove a single document from the store, given its document ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            document_id: The document ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a document has indeed been deleted, False if ID not found.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="c1"># self.collection is not None (by _ensure_astra_db_client)</span>
        <span class="n">deletion_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">document_id</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">deletion_response</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">==</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.adelete_by_document_id">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.adelete_by_document_id">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">adelete_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Remove a single document from the store, given its document ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            document_id: The document ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a document has indeed been deleted, False if ID not found.</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">deletion_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">document_id</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">deletion_response</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">==</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.delete">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.delete">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Delete by vector ids.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: List of ids to delete.</span>
<span class="sd">            concurrency: max number of threads issuing single-doc delete requests.</span>
<span class="sd">                Defaults to vector-store overall setting.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if deletion is (entirely) successful, False otherwise.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"Method 'delete' of AstraDBVectorStore vector store invoked with "</span>
                <span class="sa">f</span><span class="s2">"unsupported arguments (</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">), "</span>
                <span class="s2">"which will be ignored."</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"No ids provided to delete."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">_max_workers</span> <span class="o">=</span> <span class="n">concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_delete_concurrency</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">_max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">tpe</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">tpe</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_by_document_id</span><span class="p">,</span>
                    <span class="n">ids</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.adelete">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.adelete">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">adelete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Delete by vector ids.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: List of ids to delete.</span>
<span class="sd">            concurrency: max number of simultaneous coroutines for single-doc</span>
<span class="sd">                delete requests. Defaults to vector-store overall setting.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if deletion is (entirely) successful, False otherwise.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"Method 'adelete' of AstraDBVectorStore invoked with "</span>
                <span class="sa">f</span><span class="s2">"unsupported arguments (</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">), "</span>
                <span class="s2">"which will be ignored."</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"No ids provided to delete."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">_max_workers</span> <span class="o">=</span> <span class="n">concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_delete_concurrency</span>
        <span class="k">await</span> <span class="n">gather_with_concurrency</span><span class="p">(</span>
            <span class="n">_max_workers</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adelete_by_document_id</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.delete_by_metadata_filter">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.delete_by_metadata_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_by_metadata_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Delete all documents matching a certain metadata filtering condition.</span>

<span class="sd">        This operation does not use the vector embeddings in any way, it simply</span>
<span class="sd">        removes all documents whose metadata match the provided condition.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter: Filter on the metadata to apply. The filter cannot be empty.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A number expressing the amount of deleted documents.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"Method `delete_by_metadata_filter` does not accept an empty "</span>
                <span class="s2">"filter. Use the `clear()` method if you really want to empty "</span>
                <span class="s2">"the vector store."</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">metadata_parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_to_query</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">del_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">metadata_parameter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">del_result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="ow">or</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.adelete_by_metadata_filter">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.adelete_by_metadata_filter">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">adelete_by_metadata_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Delete all documents matching a certain metadata filtering condition.</span>

<span class="sd">        This operation does not use the vector embeddings in any way, it simply</span>
<span class="sd">        removes all documents whose metadata match the provided condition.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter: Filter on the metadata to apply. The filter cannot be empty.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A number expressing the amount of deleted documents.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"Method `adelete_by_metadata_filter` does not accept an empty "</span>
                <span class="s2">"filter. Use the `aclear()` method if you really want to empty "</span>
                <span class="s2">"the vector store."</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">metadata_parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_to_query</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">del_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">metadata_parameter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">del_result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="ow">or</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.delete_collection">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.delete_collection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Completely delete the collection from the database.</span>

<span class="sd">        Completely delete the collection from the database (as opposed</span>
<span class="sd">        to :meth:`~clear`, which empties it only).</span>
<span class="sd">        Stored data is lost and unrecoverable, resources are freed.</span>
<span class="sd">        Use with caution.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.adelete_collection">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.adelete_collection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">adelete_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Completely delete the collection from the database.</span>

<span class="sd">        Completely delete the collection from the database (as opposed</span>
<span class="sd">        to :meth:`~aclear`, which empties it only).</span>
<span class="sd">        Stored data is lost and unrecoverable, resources are freed.</span>
<span class="sd">        Use with caution.</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_documents_to_insert</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embedding_vectors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metadatas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
        <span class="n">documents_to_insert</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="n">b_txt</span><span class="p">,</span>
                <span class="n">document_id</span><span class="o">=</span><span class="n">b_id</span><span class="p">,</span>
                <span class="n">vector</span><span class="o">=</span><span class="n">b_emb</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">b_md</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">b_txt</span><span class="p">,</span> <span class="n">b_emb</span><span class="p">,</span> <span class="n">b_id</span><span class="p">,</span> <span class="n">b_md</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">texts</span><span class="p">,</span>
                <span class="n">embedding_vectors</span><span class="p">,</span>
                <span class="n">ids</span><span class="p">,</span>
                <span class="n">metadatas</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># make unique by id, keeping the last</span>
        <span class="k">return</span> <span class="n">_unique_list</span><span class="p">(</span>
            <span class="n">documents_to_insert</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">,</span>
        <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="AstraDBVectorStore.add_texts">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.add_texts">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_texts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Run texts through the embeddings and add them to the vectorstore.</span>

<span class="sd">        If passing explicit ids, those entries whose id is in the store already</span>
<span class="sd">        will be replaced.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: Texts to add to the vectorstore.</span>
<span class="sd">            metadatas: Optional list of metadatas.</span>
<span class="sd">            ids: Optional list of ids.</span>
<span class="sd">            batch_size: Size of document chunks for each individual insertion</span>
<span class="sd">                API request. If not provided, defaults to the vector-store</span>
<span class="sd">                overall defaults (which in turn falls to astrapy defaults).</span>
<span class="sd">            batch_concurrency: number of threads to process</span>
<span class="sd">                insertion batches concurrently. Defaults to the vector-store</span>
<span class="sd">                overall setting if not provided.</span>
<span class="sd">            overwrite_concurrency: number of threads to process</span>
<span class="sd">                pre-existing documents in each batch. Defaults to the vector-store</span>
<span class="sd">                overall setting if not provided.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Note:</span>
<span class="sd">            The allowed field names for the metadata document attributes must</span>
<span class="sd">            obey certain rules (such as: keys cannot start with a dollar sign</span>
<span class="sd">            and cannot be empty).</span>
<span class="sd">            See `Naming Conventions &lt;https://docs.datastax.com/en/astra-db-serverless/api-reference/dataapiclient.html#naming-conventions&gt;`_</span>
<span class="sd">            for details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of ids of the added texts.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"Method 'add_texts' of AstraDBVectorStore vector store invoked with "</span>
                <span class="sa">f</span><span class="s2">"unsupported arguments (</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">), "</span>
                <span class="s2">"which will be ignored."</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>

        <span class="n">embedding_vectors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
        <span class="n">documents_to_insert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_documents_to_insert</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span> <span class="n">embedding_vectors</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">,</span> <span class="n">ids</span>
        <span class="p">)</span>

        <span class="c1"># perform an AstraPy insert_many, catching exceptions for overwriting docs</span>
        <span class="n">ids_to_replace</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">inserted_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">insert_many_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span>
                <span class="n">documents_to_insert</span><span class="p">,</span>
                <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">concurrency</span><span class="o">=</span><span class="n">batch_concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_batch_concurrency</span><span class="p">,</span>
                <span class="n">chunk_size</span><span class="o">=</span><span class="n">batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ids_to_replace</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">inserted_ids</span> <span class="o">=</span> <span class="n">insert_many_result</span><span class="o">.</span><span class="n">inserted_ids</span>
        <span class="k">except</span> <span class="n">CollectionInsertManyException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># check that the error is solely due to already-existing documents</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_err</span><span class="p">,</span> <span class="n">DataAPIResponseException</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">in_err</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">exceptions</span>
            <span class="p">):</span>
                <span class="n">full_err_message</span> <span class="o">=</span> <span class="n">_insertmany_error_message</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">full_err_message</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
            <span class="c1"># here, assume all in err.exceptions is a DataAPIResponseException:</span>
            <span class="n">error_codes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">err_desc</span><span class="o">.</span><span class="n">error_code</span>
                <span class="k">for</span> <span class="n">in_err</span> <span class="ow">in</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="n">DataAPIResponseException</span><span class="p">],</span> <span class="n">err</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">err_desc</span> <span class="ow">in</span> <span class="n">in_err</span><span class="o">.</span><span class="n">error_descriptors</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">error_codes</span> <span class="o">==</span> <span class="p">{</span><span class="n">DOCUMENT_ALREADY_EXISTS_API_ERROR_CODE</span><span class="p">}:</span>
                <span class="n">inserted_ids</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">inserted_ids</span>
                <span class="n">inserted_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inserted_ids</span><span class="p">)</span>
                <span class="n">ids_to_replace</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">doc_id</span>
                    <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents_to_insert</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">doc_id</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="n">inserted_ids_set</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_err_message</span> <span class="o">=</span> <span class="n">_insertmany_error_message</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">full_err_message</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="c1"># if necessary, replace docs for the non-inserted ids</span>
        <span class="k">if</span> <span class="n">ids_to_replace</span><span class="p">:</span>
            <span class="n">documents_to_replace</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">document</span>
                <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents_to_insert</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ids_to_replace</span>
            <span class="p">]</span>

            <span class="n">_max_workers</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">overwrite_concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
                <span class="n">max_workers</span><span class="o">=</span><span class="n">_max_workers</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_replace_document</span><span class="p">(</span>
                    <span class="n">document</span><span class="p">:</span> <span class="n">DocDict</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CollectionUpdateResult</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
                    <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]),</span>
                        <span class="n">document</span><span class="p">,</span>
                    <span class="p">),</span> <span class="n">doc_id</span>

                <span class="n">replace_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                        <span class="n">_replace_document</span><span class="p">,</span>
                        <span class="n">documents_to_replace</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">replaced_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r_res</span><span class="o">.</span><span class="n">update_info</span><span class="p">[</span><span class="s2">"n"</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_res</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">replace_results</span><span class="p">)</span>
            <span class="n">inserted_ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">replaced_id</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">replaced_id</span> <span class="ow">in</span> <span class="n">replace_results</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">replaced_count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_to_replace</span><span class="p">):</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_to_replace</span><span class="p">)</span> <span class="o">-</span> <span class="n">replaced_count</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">"AstraDBVectorStore.add_texts could not insert all requested "</span>
                    <span class="sa">f</span><span class="s2">"documents (</span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2"> failed replace_one calls)"</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inserted_ids</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.aadd_texts">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.aadd_texts">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aadd_texts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Run texts through the embeddings and add them to the vectorstore.</span>

<span class="sd">        If passing explicit ids, those entries whose id is in the store already</span>
<span class="sd">        will be replaced.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: Texts to add to the vectorstore.</span>
<span class="sd">            metadatas: Optional list of metadatas.</span>
<span class="sd">            ids: Optional list of ids.</span>
<span class="sd">            batch_size: Size of document chunks for each individual insertion</span>
<span class="sd">                API request. If not provided, defaults to the vector-store</span>
<span class="sd">                overall defaults (which in turn falls to astrapy defaults).</span>
<span class="sd">            batch_concurrency: number of simultaneous coroutines to process</span>
<span class="sd">                insertion batches concurrently. Defaults to the vector-store</span>
<span class="sd">                overall setting if not provided.</span>
<span class="sd">            overwrite_concurrency: number of simultaneous coroutines to process</span>
<span class="sd">                pre-existing documents in each batch. Defaults to the vector-store</span>
<span class="sd">                overall setting if not provided.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Note:</span>
<span class="sd">            The allowed field names for the metadata document attributes must</span>
<span class="sd">            obey certain rules (such as: keys cannot start with a dollar sign</span>
<span class="sd">            and cannot be empty).</span>
<span class="sd">            See `Naming Conventions &lt;https://docs.datastax.com/en/astra-db-serverless/api-reference/dataapiclient.html#naming-conventions&gt;`_</span>
<span class="sd">            for details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of ids of the added texts.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"Method 'aadd_texts' of AstraDBVectorStore invoked with "</span>
                <span class="sa">f</span><span class="s2">"unsupported arguments (</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">), "</span>
                <span class="s2">"which will be ignored."</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>

        <span class="n">embedding_vectors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_vectors</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">aembed_documents</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">documents_to_insert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_documents_to_insert</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span> <span class="n">embedding_vectors</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">,</span> <span class="n">ids</span>
        <span class="p">)</span>

        <span class="c1"># perform an AstraPy insert_many, catching exceptions for overwriting docs</span>
        <span class="n">ids_to_replace</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">inserted_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">insert_many_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span>
                <span class="n">documents_to_insert</span><span class="p">,</span>
                <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">concurrency</span><span class="o">=</span><span class="n">batch_concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_batch_concurrency</span><span class="p">,</span>
                <span class="n">chunk_size</span><span class="o">=</span><span class="n">batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ids_to_replace</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">inserted_ids</span> <span class="o">=</span> <span class="n">insert_many_result</span><span class="o">.</span><span class="n">inserted_ids</span>
        <span class="k">except</span> <span class="n">CollectionInsertManyException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># check that the error is solely due to already-existing documents</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_err</span><span class="p">,</span> <span class="n">DataAPIResponseException</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">in_err</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">exceptions</span>
            <span class="p">):</span>
                <span class="n">full_err_message</span> <span class="o">=</span> <span class="n">_insertmany_error_message</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">full_err_message</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
            <span class="c1"># here, assume all in err.exceptions is a DataAPIResponseException:</span>
            <span class="n">error_codes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">err_desc</span><span class="o">.</span><span class="n">error_code</span>
                <span class="k">for</span> <span class="n">in_err</span> <span class="ow">in</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="n">DataAPIResponseException</span><span class="p">],</span> <span class="n">err</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">err_desc</span> <span class="ow">in</span> <span class="n">in_err</span><span class="o">.</span><span class="n">error_descriptors</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">error_codes</span> <span class="o">==</span> <span class="p">{</span><span class="n">DOCUMENT_ALREADY_EXISTS_API_ERROR_CODE</span><span class="p">}:</span>
                <span class="n">inserted_ids</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">inserted_ids</span>
                <span class="n">inserted_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inserted_ids</span><span class="p">)</span>
                <span class="n">ids_to_replace</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">doc_id</span>
                    <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents_to_insert</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">doc_id</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="n">inserted_ids_set</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_err_message</span> <span class="o">=</span> <span class="n">_insertmany_error_message</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">full_err_message</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="c1"># if necessary, replace docs for the non-inserted ids</span>
        <span class="k">if</span> <span class="n">ids_to_replace</span><span class="p">:</span>
            <span class="n">documents_to_replace</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">document</span>
                <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents_to_insert</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ids_to_replace</span>
            <span class="p">]</span>

            <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span>
                <span class="n">overwrite_concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">_async_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_replace_document</span><span class="p">(</span>
                <span class="n">document</span><span class="p">:</span> <span class="n">DocDict</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CollectionUpdateResult</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
                    <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">_async_collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]),</span>
                        <span class="n">document</span><span class="p">,</span>
                    <span class="p">),</span> <span class="n">doc_id</span>

            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_replace_document</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents_to_replace</span>
            <span class="p">]</span>

            <span class="n">replace_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">replaced_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r_res</span><span class="o">.</span><span class="n">update_info</span><span class="p">[</span><span class="s2">"n"</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_res</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">replace_results</span><span class="p">)</span>
            <span class="n">inserted_ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">replaced_id</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">replaced_id</span> <span class="ow">in</span> <span class="n">replace_results</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">replaced_count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_to_replace</span><span class="p">):</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_to_replace</span><span class="p">)</span> <span class="o">-</span> <span class="n">replaced_count</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">"AstraDBVectorStore.add_texts could not insert all requested "</span>
                    <span class="sa">f</span><span class="s2">"documents (</span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2"> failed replace_one calls)"</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inserted_ids</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.update_metadata">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.update_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">id_to_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">overwrite_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add/overwrite the metadata of existing documents.</span>

<span class="sd">        For each document to update, the new metadata dictionary is appended</span>
<span class="sd">        to the existing metadata, overwriting individual keys that existed already.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_to_metadata: map from the Document IDs to modify to the</span>
<span class="sd">                new metadata for updating. Keys in this dictionary that</span>
<span class="sd">                do not correspond to an existing document will be silently ignored.</span>
<span class="sd">                The values of this map are metadata dictionaries for updating</span>
<span class="sd">                the documents. Any pre-existing metadata will be merged with</span>
<span class="sd">                these entries, which take precedence on a key-by-key basis.</span>
<span class="sd">            overwrite_concurrency: number of threads to process the updates.</span>
<span class="sd">                Defaults to the vector-store overall setting if not provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the number of documents successfully updated (i.e. found to exist,</span>
<span class="sd">            since even an update with `{}` as the new metadata counts as successful.)</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>

        <span class="n">_max_workers</span> <span class="o">=</span> <span class="n">overwrite_concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="n">_max_workers</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_update_document</span><span class="p">(</span>
                <span class="n">id_md_pair</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionUpdateResult</span><span class="p">:</span>
                <span class="n">document_id</span><span class="p">,</span> <span class="n">update_metadata</span> <span class="o">=</span> <span class="n">id_md_pair</span>
                <span class="n">encoded_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_to_query</span><span class="p">(</span><span class="n">update_metadata</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">document_id</span><span class="p">]),</span>
                    <span class="p">{</span><span class="s2">"$set"</span><span class="p">:</span> <span class="n">encoded_metadata</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="n">update_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="n">_update_document</span><span class="p">,</span>
                    <span class="n">id_to_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u_res</span><span class="o">.</span><span class="n">update_info</span><span class="p">[</span><span class="s2">"n"</span><span class="p">]</span> <span class="k">for</span> <span class="n">u_res</span> <span class="ow">in</span> <span class="n">update_results</span><span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.aupdate_metadata">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.aupdate_metadata">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aupdate_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">id_to_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">overwrite_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add/overwrite the metadata of existing documents.</span>

<span class="sd">        For each document to update, the new metadata dictionary is appended</span>
<span class="sd">        to the existing metadata, overwriting individual keys that existed already.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_to_metadata: map from the Document IDs to modify to the</span>
<span class="sd">                new metadata for updating. Keys in this dictionary that</span>
<span class="sd">                do not correspond to an existing document will be silently ignored.</span>
<span class="sd">                The values of this map are metadata dictionaries for updating</span>
<span class="sd">                the documents. Any pre-existing metadata will be merged with</span>
<span class="sd">                these entries, which take precedence on a key-by-key basis.</span>
<span class="sd">            overwrite_concurrency: number of asynchronous tasks to process the updates.</span>
<span class="sd">                Defaults to the vector-store overall setting if not provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the number of documents successfully updated (i.e. found to exist,</span>
<span class="sd">            since even an update with `{}` as the new metadata counts as successful.)</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>

        <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span>
            <span class="n">overwrite_concurrency</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_insert_overwrite_concurrency</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_async_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_document</span><span class="p">(</span>
            <span class="n">id_md_pair</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionUpdateResult</span><span class="p">:</span>
            <span class="n">document_id</span><span class="p">,</span> <span class="n">update_metadata</span> <span class="o">=</span> <span class="n">id_md_pair</span>
            <span class="n">encoded_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_to_query</span><span class="p">(</span><span class="n">update_metadata</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">_async_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">document_id</span><span class="p">]),</span>
                    <span class="p">{</span><span class="s2">"$set"</span><span class="p">:</span> <span class="n">encoded_metadata</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_update_document</span><span class="p">(</span><span class="n">id_md_pair</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">id_md_pair</span> <span class="ow">in</span> <span class="n">id_to_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">update_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u_res</span><span class="o">.</span><span class="n">update_info</span><span class="p">[</span><span class="s2">"n"</span><span class="p">]</span> <span class="k">for</span> <span class="n">u_res</span> <span class="ow">in</span> <span class="n">update_results</span><span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.full_decode_astra_db_found_document">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.full_decode_astra_db_found_document">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_decode_astra_db_found_document</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">astra_db_document</span><span class="p">:</span> <span class="n">DocDict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBQueryResult</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Decode an Astra DB document in full, i.e. into Document+embedding/similarity.</span>

<span class="sd">        This operation returns a representation that is independent of the codec</span>
<span class="sd">        being used in the collection (whereas the input, a 'raw' Astra DB document,</span>
<span class="sd">        is codec-dependent).</span>

<span class="sd">        The input raw document can carry information on embedding and similarity,</span>
<span class="sd">        depending on details of the query used to retrieve it. These can be set</span>
<span class="sd">        to None in the resulf if not found.</span>

<span class="sd">        The whole method can return a None, to signal that the codec has refused</span>
<span class="sd">        the conversion (e.g. because the input document is deemed faulty).</span>

<span class="sd">        Args:</span>
<span class="sd">            astra_db_document: a dictionary obtained through `run_query_raw` from</span>
<span class="sd">                the collection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            a AstraDBQueryResult named tuple with Document, id, embedding</span>
<span class="sd">                (where applicable) and similarity (where applicable),</span>
<span class="sd">                or an overall None if the decoding is refused by the codec.</span>
<span class="sd">        """</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decoded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
            <span class="n">doc_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">decode_vector</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
            <span class="n">doc_similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_similarity</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AstraDBQueryResult</span><span class="p">(</span>
                <span class="n">document</span><span class="o">=</span><span class="n">decoded</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">,</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">doc_embedding</span><span class="p">,</span>
                <span class="n">similarity</span><span class="o">=</span><span class="n">doc_similarity</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.full_decode_astra_db_reranked_result">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.full_decode_astra_db_reranked_result">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_decode_astra_db_reranked_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">astra_db_reranked_result</span><span class="p">:</span> <span class="n">RerankedResult</span><span class="p">[</span><span class="n">DocDict</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBQueryResult</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Full-decode an Astra DB find-and-rerank hit (Document+embedding/similarity).</span>

<span class="sd">        This operation returns a representation that is independent of the codec</span>
<span class="sd">        being used in the collection (whereas the 'document' part of the input,</span>
<span class="sd">        a 'raw' Astra DB response from a find-and-rerank hybrid search, is</span>
<span class="sd">        codec-dependent).</span>

<span class="sd">        The input raw document is what the find_and_rerank Astrapy method returns,</span>
<span class="sd">        i.e. an iterable over RerankedResult objects. Missing entries (such as</span>
<span class="sd">        the embedding) are  set to None in the resulf if not found.</span>

<span class="sd">        The whole method can return a None, to signal that the codec has refused</span>
<span class="sd">        the conversion (e.g. because the input document is deemed faulty).</span>

<span class="sd">        Args:</span>
<span class="sd">            astra_db_reranked_result: a RerankedResult obtained by a `find_and_rerank`</span>
<span class="sd">                method call on the collection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            a AstraDBQueryResult named tuple with Document, id, embedding</span>
<span class="sd">                (where applicable) and similarity (where applicable),</span>
<span class="sd">                or an overall None if the decoding is refused by the codec.</span>
<span class="sd">        """</span>
        <span class="n">astra_db_document</span> <span class="o">=</span> <span class="n">astra_db_reranked_result</span><span class="o">.</span><span class="n">document</span>
        <span class="n">astra_db_scores</span> <span class="o">=</span> <span class="n">astra_db_reranked_result</span><span class="o">.</span><span class="n">scores</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decoded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
            <span class="n">doc_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">decode_vector</span><span class="p">(</span><span class="n">astra_db_document</span><span class="p">)</span>
            <span class="n">doc_similarity</span> <span class="o">=</span> <span class="n">astra_db_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RERANK_SCORE_KEY</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AstraDBQueryResult</span><span class="p">(</span>
                <span class="n">document</span><span class="o">=</span><span class="n">decoded</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">,</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">doc_embedding</span><span class="p">,</span>
                <span class="n">similarity</span><span class="o">=</span><span class="n">doc_similarity</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_query_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_query_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]]:</span> <span class="o">...</span>

<div class="viewcode-block" id="AstraDBVectorStore.run_query_raw">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.run_query_raw">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_query_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Execute a generic query on stored documents, returning Astra DB documents.</span>

<span class="sd">        The return value has a variable format, depending on whether the 'sort vector'</span>
<span class="sd">        is requested back from the server.</span>

<span class="sd">        Only the `n` parameter is required. Omitting all other parameters results</span>
<span class="sd">        in a query that matches each and every document found on the collection.</span>

<span class="sd">        The method does not expose a projection directly, which is instead</span>
<span class="sd">        automatically determined based on the invocation options.</span>

<span class="sd">        The returned documents are exactly as they come back from Astra DB (taking</span>
<span class="sd">        into account the projection as well). A further step, namely subsequent</span>
<span class="sd">        invocation of the `convert_astra_db_document` method, is required to reconstruct</span>
<span class="sd">        codec-independent Document objects.</span>
<span class="sd">        The reason for keeping the retrieval and the decoding steps separate is that</span>
<span class="sd">        a caller may want to first deduplicate/discard items, in order to convert only</span>
<span class="sd">        the items actually needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: amount of items to return. Fewer items than `n` may be returned  if</span>
<span class="sd">                the collection has not enough matches.</span>
<span class="sd">            ids: a list of document IDs to restrict the query to. If this is supplied,</span>
<span class="sd">                only document with an ID among the provided one will match. If further</span>
<span class="sd">                query filters are provided (i.e. metadata), matches must satisfy both</span>
<span class="sd">                requirements.</span>
<span class="sd">            filter: a metadata filtering part. If provided, it must refer to</span>
<span class="sd">                metadata keys by their bare name (such as `{"key": 123}`).</span>
<span class="sd">                This filter can combine nested conditions with "$or"/"$and" connectors,</span>
<span class="sd">                for example:</span>
<span class="sd">                - `{"tag": "a"}`</span>
<span class="sd">                - `{"$or": [{"tag": "a"}, "label": "b"]}`</span>
<span class="sd">                - `{"$and": [{"tag": {"$in": ["a", "z"]}}, "label": "b"]}`</span>
<span class="sd">            sort: a 'sort' clause for the query, such as `{"$vector": [...]}`,</span>
<span class="sd">                `{"$vectorize": "..."}` or `{"mdkey": 1}`. Metadata sort conditions</span>
<span class="sd">                must be expressed by their 'bare' name.</span>
<span class="sd">            include_similarity: whether to return similarity scores with each match.</span>
<span class="sd">                Requires vector sort.</span>
<span class="sd">            include_sort_vector: whether to return the very query vector used for the</span>
<span class="sd">                ANN search alongside the iterable of results. Requires vector sort.</span>
<span class="sd">                Note that the shape of the return value depends on this parameter.</span>
<span class="sd">            include_embeddings: whether to retrieve the matches' own embedding vectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The shape of the return value depends on the value of `include_sort_vector`:</span>
<span class="sd">            * if `include_sort_vector = False`, the return value is an iterable over</span>
<span class="sd">                Astra DB documents (dictionaries);</span>
<span class="sd">            * if `include_sort_vector = True`, the return value is a 2-item tuple</span>
<span class="sd">                `(sort_v, astra_db_ite)` tuple, where:</span>
<span class="sd">                - `sort_v` is the sort vector, if requested, or None if not available.</span>
<span class="sd">                - `astra_db_ite` is an iterable over Astra DB documents (dictionaries).</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>

        <span class="n">find_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">find_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_filter</span><span class="p">(</span><span class="n">sort</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">find_projection</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">full_projection</span>
            <span class="k">if</span> <span class="n">include_embeddings</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">base_projection</span>
        <span class="p">)</span>

        <span class="n">find_raw_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">find_query</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="n">find_projection</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="n">include_similarity</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="n">include_sort_vector</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">find_sort</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># stripping down the Astra DB cursor details into a plain iterator:</span>
        <span class="n">final_doc_iterator</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">find_raw_iterator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_sort_vector</span><span class="p">:</span>
            <span class="c1"># the codec option in the AstraDBEnv class disables DataAPIVectors here:</span>
            <span class="n">sort_vector</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                <span class="p">(</span><span class="n">find_raw_iterator</span><span class="o">.</span><span class="n">get_sort_vector</span><span class="p">()</span> <span class="k">if</span> <span class="n">include_sort_vector</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sort_vector</span><span class="p">,</span> <span class="n">final_doc_iterator</span>
        <span class="k">return</span> <span class="n">final_doc_iterator</span></div>


    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]]:</span> <span class="o">...</span>

<div class="viewcode-block" id="AstraDBVectorStore.run_query">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.run_query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]]</span>
        <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Execute a generic query on stored documents, returning Documents+other info.</span>

<span class="sd">        The return value has a variable format, depending on whether the 'sort vector'</span>
<span class="sd">        is requested back from the server.</span>

<span class="sd">        Only the `n` parameter is required. Omitting all other parameters results</span>
<span class="sd">        in a query that matches each and every document found on the collection.</span>

<span class="sd">        The method does not expose a projection directly, which is instead</span>
<span class="sd">        automatically determined based on the invocation options.</span>

<span class="sd">        The returned Document objects are codec-independent.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: amount of items to return. Fewer items than `n` may be returned in the</span>
<span class="sd">                following cases: (a) the decoding skips some raw entries from</span>
<span class="sd">                the server; (b) the collection has not enough matches.</span>
<span class="sd">            ids: a list of document IDs to restrict the query to. If this is supplied,</span>
<span class="sd">                only document with an ID among the provided one will match. If further</span>
<span class="sd">                query filters are provided (i.e. metadata), matches must satisfy both</span>
<span class="sd">                requirements.</span>
<span class="sd">            filter: a metadata filtering part. If provided, it must refer to</span>
<span class="sd">                metadata keys by their bare name (such as `{"key": 123}`).</span>
<span class="sd">                This filter can combine nested conditions with "$or"/"$and" connectors,</span>
<span class="sd">                for example:</span>
<span class="sd">                - `{"tag": "a"}`</span>
<span class="sd">                - `{"$or": [{"tag": "a"}, "label": "b"]}`</span>
<span class="sd">                - `{"$and": [{"tag": {"$in": ["a", "z"]}}, "label": "b"]}`</span>
<span class="sd">            sort: a 'sort' clause for the query, such as `{"$vector": [...]}`,</span>
<span class="sd">                `{"$vectorize": "..."}` or `{"mdkey": 1}`. Metadata sort conditions</span>
<span class="sd">                must be expressed by their 'bare' name.</span>
<span class="sd">            include_similarity: whether to return similarity scores with each match.</span>
<span class="sd">                Requires vector sort.</span>
<span class="sd">            include_sort_vector: whether to return the very query vector used for the</span>
<span class="sd">                ANN search alongside the iterable of results. Requires vector sort.</span>
<span class="sd">                Note that the shape of the return value depends on this parameter.</span>
<span class="sd">            include_embeddings: whether to retrieve the matches' own embedding vectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The shape of the return value depends on the value of `include_sort_vector`:</span>
<span class="sd">            * if `include_sort_vector = False`, the return value is an iterable over</span>
<span class="sd">                the AstraDBQueryResult items returned by the query. Entries that fail</span>
<span class="sd">                the decoding step, if any, are discarded after the query, which may</span>
<span class="sd">                lead to fewer items being returned than the required `n`.</span>
<span class="sd">            * if `include_sort_vector = True`, the return value is a 2-item tuple</span>
<span class="sd">                `(sort_v, results_ite)` tuple, where:</span>
<span class="sd">                - `sort_v` is the sort vector, if requested, or None if not available.</span>
<span class="sd">                - `results_ite` is an iterable over AstraDBQueryResult items as above.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">include_sort_vector</span><span class="p">:</span>
            <span class="n">query_v</span><span class="p">,</span> <span class="n">astra_docs_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query_raw</span><span class="p">(</span>
                <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">include_similarity</span><span class="o">=</span><span class="n">include_similarity</span><span class="p">,</span>
                <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">include_embeddings</span><span class="o">=</span><span class="n">include_embeddings</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">query_v</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">decoded_tuple</span>
                    <span class="k">for</span> <span class="n">astra_db_doc</span> <span class="ow">in</span> <span class="n">astra_docs_ite</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">decoded_tuple</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_decode_astra_db_found_document</span><span class="p">(</span>
                            <span class="n">astra_db_doc</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="n">astra_docs_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query_raw</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="n">include_similarity</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_embeddings</span><span class="o">=</span><span class="n">include_embeddings</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">decoded_tuple</span>
            <span class="k">for</span> <span class="n">astra_db_doc</span> <span class="ow">in</span> <span class="n">astra_docs_ite</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">decoded_tuple</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_decode_astra_db_found_document</span><span class="p">(</span>
                    <span class="n">astra_db_doc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span></div>


    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_query_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_query_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]]:</span> <span class="o">...</span>

<div class="viewcode-block" id="AstraDBVectorStore.arun_query_raw">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.arun_query_raw">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_query_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]]</span> <span class="o">|</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">DocDict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Execute a generic query on stored documents, returning Astra DB documents.</span>

<span class="sd">        The return value has a variable format, depending on whether the 'sort vector'</span>
<span class="sd">        is requested back from the server.</span>

<span class="sd">        Only the `n` parameter is required. Omitting all other parameters results</span>
<span class="sd">        in a query that matches each and every document found on the collection.</span>

<span class="sd">        The method does not expose a projection directly, which is instead</span>
<span class="sd">        automatically determined based on the invocation options.</span>

<span class="sd">        The returned documents are exactly as they come back from Astra DB (taking</span>
<span class="sd">        into account the projection as well). A further step, namely subsequent</span>
<span class="sd">        invocation of the `convert_astra_db_document` method, is required to reconstruct</span>
<span class="sd">        codec-independent Document objects.</span>
<span class="sd">        The reason for keeping the retrieval and the decoding steps separate is that</span>
<span class="sd">        a caller may want to first deduplicate/discard items, in order to convert only</span>
<span class="sd">        the items actually needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: amount of items to return. Fewer items than `n` may be returned in the</span>
<span class="sd">                following cases: (a) the decoding skips some raw entries from</span>
<span class="sd">                the server; (b) the collection has not enough matches.</span>
<span class="sd">            ids: a list of document IDs to restrict the query to. If this is supplied,</span>
<span class="sd">                only document with an ID among the provided one will match. If further</span>
<span class="sd">                query filters are provided (i.e. metadata), matches must satisfy both</span>
<span class="sd">                requirements.</span>
<span class="sd">            filter: a metadata filtering part. If provided, it must refer to</span>
<span class="sd">                metadata keys by their bare name (such as `{"key": 123}`).</span>
<span class="sd">                This filter can combine nested conditions with "$or"/"$and" connectors,</span>
<span class="sd">                for example:</span>
<span class="sd">                - `{"tag": "a"}`</span>
<span class="sd">                - `{"$or": [{"tag": "a"}, "label": "b"]}`</span>
<span class="sd">                - `{"$and": [{"tag": {"$in": ["a", "z"]}}, "label": "b"]}`</span>
<span class="sd">            sort: a 'sort' clause for the query, such as `{"$vector": [...]}`,</span>
<span class="sd">                `{"$vectorize": "..."}` or `{"mdkey": 1}`. Metadata sort conditions</span>
<span class="sd">                must be expressed by their 'bare' name.</span>
<span class="sd">            include_similarity: whether to return similarity scores with each match.</span>
<span class="sd">                Requires vector sort.</span>
<span class="sd">            include_sort_vector: whether to return the very query vector used for the</span>
<span class="sd">                ANN search alongside the iterable of results. Requires vector sort.</span>
<span class="sd">                Note that the shape of the return value depends on this parameter.</span>
<span class="sd">            include_embeddings: whether to retrieve the matches' own embedding vectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The shape of the return value depends on the value of `include_sort_vector`:</span>
<span class="sd">            * if `include_sort_vector = False`, the return value is an iterable over</span>
<span class="sd">                Astra DB documents (dictionaries);</span>
<span class="sd">            * if `include_sort_vector = True`, the return value is a 2-item tuple</span>
<span class="sd">                `(sort_v, astra_db_ite)` tuple, where:</span>
<span class="sd">                - `sort_v` is the sort vector, if requested, or None if not available.</span>
<span class="sd">                - `astra_db_ite` is an iterable over Astra DB documents (dictionaries).</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>

        <span class="n">find_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">find_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_filter</span><span class="p">(</span><span class="n">sort</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">find_projection</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">full_projection</span>
            <span class="k">if</span> <span class="n">include_embeddings</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">base_projection</span>
        <span class="p">)</span>

        <span class="n">find_raw_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">find_query</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="n">find_projection</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="n">include_similarity</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="n">include_sort_vector</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">find_sort</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># stripping down the Astra DB cursor details into a plain iterator:</span>
        <span class="n">final_doc_iterator</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc</span> <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">find_raw_iterator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_sort_vector</span><span class="p">:</span>
            <span class="c1"># the codec option in the AstraDBEnv class disables DataAPIVectors here:</span>
            <span class="n">sort_vector</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                <span class="p">(</span>
                    <span class="k">await</span> <span class="n">find_raw_iterator</span><span class="o">.</span><span class="n">get_sort_vector</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">include_sort_vector</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sort_vector</span><span class="p">,</span> <span class="n">final_doc_iterator</span>
        <span class="k">return</span> <span class="n">final_doc_iterator</span></div>


    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]]:</span> <span class="o">...</span>

<div class="viewcode-block" id="AstraDBVectorStore.arun_query">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.arun_query">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">arun_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_similarity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_sort_vector</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]]</span>
        <span class="o">|</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">AstraDBQueryResult</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Execute a generic query on stored documents, returning Documents+other info.</span>

<span class="sd">        The return value has a variable format, depending on whether the 'sort vector'</span>
<span class="sd">        is requested back from the server.</span>

<span class="sd">        Only the `n` parameter is required. Omitting all other parameters results</span>
<span class="sd">        in a query that matches each and every document found on the collection.</span>

<span class="sd">        The method does not expose a projection directly, which is instead</span>
<span class="sd">        automatically determined based on the invocation options.</span>

<span class="sd">        The returned Document objects are codec-independent.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: amount of items to return. Fewer items than `n` may be returned  if</span>
<span class="sd">                the collection has not enough matches.</span>
<span class="sd">            ids: a list of document IDs to restrict the query to. If this is supplied,</span>
<span class="sd">                only document with an ID among the provided one will match. If further</span>
<span class="sd">                query filters are provided (i.e. metadata), matches must satisfy both</span>
<span class="sd">                requirements.</span>
<span class="sd">            filter: a metadata filtering part. If provided, it must refer to</span>
<span class="sd">                metadata keys by their bare name (such as `{"key": 123}`).</span>
<span class="sd">                This filter can combine nested conditions with "$or"/"$and" connectors,</span>
<span class="sd">                for example:</span>
<span class="sd">                - `{"tag": "a"}`</span>
<span class="sd">                - `{"$or": [{"tag": "a"}, "label": "b"]}`</span>
<span class="sd">                - `{"$and": [{"tag": {"$in": ["a", "z"]}}, "label": "b"]}`</span>
<span class="sd">            sort: a 'sort' clause for the query, such as `{"$vector": [...]}`,</span>
<span class="sd">                `{"$vectorize": "..."}` or `{"mdkey": 1}`. Metadata sort conditions</span>
<span class="sd">                must be expressed by their 'bare' name.</span>
<span class="sd">            include_similarity: whether to return similarity scores with each match.</span>
<span class="sd">                Requires vector sort.</span>
<span class="sd">            include_sort_vector: whether to return the very query vector used for the</span>
<span class="sd">                ANN search alongside the iterable of results. Requires vector sort.</span>
<span class="sd">                Note that the shape of the return value depends on this parameter.</span>
<span class="sd">            include_embeddings: whether to retrieve the matches' own embedding vectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The shape of the return value depends on the value of `include_sort_vector`:</span>
<span class="sd">            * if `include_sort_vector = False`, the return value is an iterable over</span>
<span class="sd">                the AstraDBQueryResult items returned by the query. Entries that fail</span>
<span class="sd">                the decoding step, if any, are discarded after the query, which may</span>
<span class="sd">                lead to fewer items being returned than the required `n`.</span>
<span class="sd">            * if `include_sort_vector = True`, the return value is a 2-item tuple</span>
<span class="sd">                `(sort_v, results_ite)` tuple, where:</span>
<span class="sd">                - `sort_v` is the sort vector, if requested, or None if not available.</span>
<span class="sd">                - `results_ite` is an iterable over AstraDBQueryResult items as above.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">include_sort_vector</span><span class="p">:</span>
            <span class="n">query_v</span><span class="p">,</span> <span class="n">astra_docs_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query_raw</span><span class="p">(</span>
                <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">include_similarity</span><span class="o">=</span><span class="n">include_similarity</span><span class="p">,</span>
                <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">include_embeddings</span><span class="o">=</span><span class="n">include_embeddings</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">query_v</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">decoded_tuple</span>
                    <span class="k">async</span> <span class="k">for</span> <span class="n">astra_db_doc</span> <span class="ow">in</span> <span class="n">astra_docs_ite</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">decoded_tuple</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_decode_astra_db_found_document</span><span class="p">(</span>
                            <span class="n">astra_db_doc</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="n">astra_docs_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query_raw</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="n">include_similarity</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_embeddings</span><span class="o">=</span><span class="n">include_embeddings</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">decoded_tuple</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">astra_db_doc</span> <span class="ow">in</span> <span class="n">astra_docs_ite</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">decoded_tuple</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_decode_astra_db_found_document</span><span class="p">(</span>
                    <span class="n">astra_db_doc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.metadata_search">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.metadata_search">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metadata_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get documents via a metadata search.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter: the metadata to query for.</span>
<span class="sd">            n: the maximum number of documents to return.</span>
<span class="sd">        """</span>
        <span class="n">docs_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">docs_ite</span><span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.ametadata_search">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.ametadata_search">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ametadata_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get documents via a metadata search.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter: the metadata to query for.</span>
<span class="sd">            n: the maximum number of documents to return.</span>
<span class="sd">        """</span>
        <span class="n">docs_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">doc</span> <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">docs_ite</span><span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.get_by_document_id">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.get_by_document_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Document</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Retrieve a single document from the store, given its document ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            document_id: The document ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            The the document if it exists. Otherwise None.</span>
<span class="sd">        """</span>
        <span class="n">hits_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">document_id</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hits_ite</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.aget_by_document_id">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.aget_by_document_id">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aget_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Document</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Retrieve a single document from the store, given its document ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            document_id: The document ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            The the document if it exists. Otherwise None.</span>
<span class="sd">        """</span>
        <span class="n">hits_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">document_id</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span> <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hits_ite</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.similarity_search">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents most similar to the query.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">doc</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_search_with_score_id_impl</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">lexical_query</span><span class="o">=</span><span class="n">lexical_query</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_with_score">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_with_score">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to query with score.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score), the most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">WARNING_HYBRID_SEARCH_WITH_SCORES</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_search_with_score_id_impl</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">lexical_query</span><span class="o">=</span><span class="n">lexical_query</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_similarity_search_with_score_id_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Implementation for similarity_search_with_score_id.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score, id), the most similar to the query.</span>
<span class="sd">        """</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">rerank_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">rerank_on</span>
            <span class="n">rerank_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_hybrid_sort</span><span class="p">(</span>
                    <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">vectorize</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">lexical</span><span class="o">=</span><span class="n">lexical_query</span> <span class="ow">or</span> <span class="n">query</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rerank_query</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_hybrid_sort</span><span class="p">(</span>
                    <span class="n">vector</span><span class="o">=</span><span class="n">embedding_vector</span><span class="p">,</span>
                    <span class="n">vectorize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">lexical</span><span class="o">=</span><span class="n">lexical_query</span> <span class="ow">or</span> <span class="n">query</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rerank_query</span> <span class="o">=</span> <span class="n">query</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hybrid_search_with_score_id_by_sort</span><span class="p">(</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">rerank_on</span><span class="o">=</span><span class="n">rerank_on</span><span class="p">,</span>
                <span class="n">rerank_query</span><span class="o">=</span><span class="n">rerank_query</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">lexical_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ERROR_LEXICAL_QUERY_ON_NONHYBRID_SEARCH</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vectorize_sort</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">embedding_vector</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_find_with_score_id_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_with_score_id">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_with_score_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_with_score_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to the query with score and id.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score, id), the most similar to the query.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">WARNING_HYBRID_SEARCH_WITH_SCORES</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_search_with_score_id_impl</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">lexical_query</span><span class="o">=</span><span class="n">lexical_query</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_by_vector">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">doc</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_search_with_score_id_by_vector</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_with_score_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_with_score_by_vector">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_with_score_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector with score.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score), the most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_search_with_score_id_by_vector</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_with_score_id_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_with_score_id_by_vector">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_with_score_id_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector with score and id.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score, id), the most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"Searching by vector on a Vector Store that uses server-side "</span>
                <span class="s2">"embeddings is not allowed."</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_find_with_score_id_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_similarity_find_with_score_id_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">filter_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Run ANN search with a provided sort clause."""</span>
        <span class="n">hits_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">filter_dict</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># doc is a Document and sim is a float:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">did</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">hits_ite</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hybrid_search_with_score_id_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">filter_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rerank_on</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rerank_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Run a hybrid search with a provided sort clause."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">encoded_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">filter_dict</span><span class="o">=</span><span class="n">filter_dict</span><span class="p">)</span>
        <span class="n">hybrid_limits</span> <span class="o">=</span> <span class="n">_make_hybrid_limits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hybrid_limit_factor</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">hybrid_reranked_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_and_rerank</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">encoded_filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">base_projection</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">hybrid_limits</span><span class="o">=</span><span class="n">hybrid_limits</span><span class="p">,</span>
            <span class="n">include_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rerank_on</span><span class="o">=</span><span class="n">rerank_on</span><span class="p">,</span>
            <span class="n">rerank_query</span><span class="o">=</span><span class="n">rerank_query</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                <span class="p">(</span>
                    <span class="n">decoded_tuple</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                    <span class="n">decoded_tuple</span><span class="o">.</span><span class="n">similarity</span><span class="p">,</span>
                    <span class="n">decoded_tuple</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">rrk_result</span> <span class="ow">in</span> <span class="n">hybrid_reranked_results</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">decoded_tuple</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_decode_astra_db_reranked_result</span><span class="p">(</span>
                    <span class="n">rrk_result</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>

<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents most similar to the query.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">doc</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_search_with_score_id_impl</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">lexical_query</span><span class="o">=</span><span class="n">lexical_query</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_with_score">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_with_score">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to query with score.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score), the most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">WARNING_HYBRID_SEARCH_WITH_SCORES</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_search_with_score_id_impl</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">lexical_query</span><span class="o">=</span><span class="n">lexical_query</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_asimilarity_search_with_score_id_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Implementation for asimilarity_search_with_score_id.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score, id), the most similar to the query.</span>
<span class="sd">        """</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">rerank_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">rerank_on</span>
            <span class="n">rerank_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_hybrid_sort</span><span class="p">(</span>
                    <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">vectorize</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">lexical</span><span class="o">=</span><span class="n">lexical_query</span> <span class="ow">or</span> <span class="n">query</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rerank_query</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">embedding_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">aembed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_hybrid_sort</span><span class="p">(</span>
                    <span class="n">vector</span><span class="o">=</span><span class="n">embedding_vector</span><span class="p">,</span>
                    <span class="n">vectorize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">lexical</span><span class="o">=</span><span class="n">lexical_query</span> <span class="ow">or</span> <span class="n">query</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rerank_query</span> <span class="o">=</span> <span class="n">query</span>

            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ahybrid_search_with_score_id_by_sort</span><span class="p">(</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="n">rerank_on</span><span class="o">=</span><span class="n">rerank_on</span><span class="p">,</span>
                <span class="n">rerank_query</span><span class="o">=</span><span class="n">rerank_query</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">lexical_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ERROR_LEXICAL_QUERY_ON_NONHYBRID_SEARCH</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vectorize_sort</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">aembed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">embedding_vector</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_find_with_score_id_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_with_score_id">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_with_score_id">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_with_score_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
        <span class="n">lexical_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to the query with score and id.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            lexical_query: for hybrid search, a specific query for the lexical</span>
<span class="sd">                portion of the retrieval. If omitted or empty, defaults to the same</span>
<span class="sd">                as 'query'. If passed on a non-hybrid search, an error is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score, id), the most similar to the query.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">WARNING_HYBRID_SEARCH_WITH_SCORES</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_search_with_score_id_impl</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">lexical_query</span><span class="o">=</span><span class="n">lexical_query</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_by_vector">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">doc</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">asimilarity_search_with_score_id_by_vector</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_with_score_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_with_score_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_with_score_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector with score.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score), the most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">scr</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">scr</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">asimilarity_search_with_score_id_by_vector</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_with_score_id_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_with_score_id_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_with_score_id_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector with score and id.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of (Document, score, id), the most similar to the query vector.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"Searching by vector on a Vector Store that uses server-side "</span>
                <span class="s2">"embeddings is not allowed."</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_find_with_score_id_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">filter_dict</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_asimilarity_find_with_score_id_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">filter_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Run ANN search with a provided sort clause."""</span>
        <span class="n">hits_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">filter_dict</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># doc is a Document and sim is a float:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">did</span><span class="p">))</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">hits_ite</span>
        <span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ahybrid_search_with_score_id_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">filter_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rerank_on</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rerank_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Run a hybrid search with a provided sort clause."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">encoded_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="n">filter_dict</span><span class="o">=</span><span class="n">filter_dict</span><span class="p">)</span>
        <span class="n">hybrid_limits</span> <span class="o">=</span> <span class="n">_make_hybrid_limits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hybrid_limit_factor</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">hybrid_reranked_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">find_and_rerank</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">encoded_filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">base_projection</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">hybrid_limits</span><span class="o">=</span><span class="n">hybrid_limits</span><span class="p">,</span>
            <span class="n">include_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rerank_on</span><span class="o">=</span><span class="n">rerank_on</span><span class="p">,</span>
            <span class="n">rerank_query</span><span class="o">=</span><span class="n">rerank_query</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                <span class="p">(</span>
                    <span class="n">decoded_tuple</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                    <span class="n">decoded_tuple</span><span class="o">.</span><span class="n">similarity</span><span class="p">,</span>
                    <span class="n">decoded_tuple</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">rrk_result</span> <span class="ow">in</span> <span class="n">hybrid_reranked_results</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">decoded_tuple</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_decode_astra_db_reranked_result</span><span class="p">(</span>
                    <span class="n">rrk_result</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>

<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_with_embedding_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_with_embedding_by_vector">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_with_embedding_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector with embedding.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (The query embedding vector, The list of (Document, embedding),</span>
<span class="sd">            the most similar to the query vector.).</span>
<span class="sd">        """</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="n">embedding</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">doc_emb_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_find_with_embedding_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">doc_emb_list</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_with_embedding_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_with_embedding_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_with_embedding_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to embedding vector with embedding.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (The query embedding vector, The list of (Document, embedding),</span>
<span class="sd">            the most similar to the query vector.).</span>
<span class="sd">        """</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="n">embedding</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">doc_emb_list</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_find_with_embedding_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">doc_emb_list</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.similarity_search_with_embedding">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.similarity_search_with_embedding">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_search_with_embedding</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to the query with embedding.</span>

<span class="sd">        Also includes the query embedding vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (The query embedding vector, The list of (Document, embedding),</span>
<span class="sd">            the most similar to the query vector.).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">"Method `similarity_search_with_embedding` was called on a vector "</span>
                    <span class="s2">"store equipped with Hybrid capabilities. Since this method cannot "</span>
                    <span class="s2">"make use of Hybrid search, the vector store will fall back to "</span>
                    <span class="s2">"regular vector ANN similarity search."</span>
                <span class="p">),</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vectorize_sort</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="c1"># shortcut return if query isn't needed.</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="n">query_embedding</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_find_with_embedding_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.asimilarity_search_with_embedding">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.asimilarity_search_with_embedding">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">asimilarity_search_with_embedding</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">"""Return docs most similar to the query with embedding.</span>

<span class="sd">        Also includes the query embedding vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (The query embedding vector, The list of (Document, embedding),</span>
<span class="sd">            the most similar to the query vector.).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">"Method `asimilarity_search_with_embedding` was called on a vector "</span>
                    <span class="s2">"store equipped with Hybrid capabilities. Since this method cannot "</span>
                    <span class="s2">"make use of Hybrid search, the vector store will fall back to "</span>
                    <span class="s2">"regular vector ANN similarity search."</span>
                <span class="p">),</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vectorize_sort</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="c1"># shortcut return if query isn't needed.</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="n">query_embedding</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asimilarity_find_with_embedding_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_similarity_find_with_embedding_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">"""Run ANN search with a provided sort clause.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (query_embedding, List of (Document, embedding) most similar to the query).</span>
<span class="sd">        """</span>
        <span class="n">sort_vec</span><span class="p">,</span> <span class="n">hits_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Unable to retrieve the server-side embedding of the query."</span>
            <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># doc is a Document and emb is a list[float]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">sort_vec</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">emb</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hits_ite</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_asimilarity_find_with_embedding_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">"""Run ANN search with a provided sort clause.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (query_embedding, List of (Document, embedding) most similar to the query).</span>
<span class="sd">        """</span>
        <span class="n">sort_vec</span><span class="p">,</span> <span class="n">hits_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Unable to retrieve the server-side embedding of the query."</span>
            <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># doc is a Document and emb is a list[float]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">sort_vec</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">emb</span><span class="p">))</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hits_ite</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_mmr_find_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="n">sort_vec</span><span class="p">,</span> <span class="n">hits_ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># this is list[tuple[Document, list[float]]]:</span>
        <span class="n">prefetch_hit_pairs</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span>
            <span class="p">[(</span><span class="n">doc</span><span class="p">,</span> <span class="n">emb</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hits_ite</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Unable to retrieve the server-side embedding of the query."</span>
            <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mmr_hits</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">sort_vec</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="n">prefetch_hit_pairs</span><span class="o">=</span><span class="n">prefetch_hit_pairs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_arun_mmr_find_by_sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="n">sort_vec</span><span class="p">,</span> <span class="n">hits_ite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">arun_query</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">include_sort_vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># this is list[tuple[Document, list[float]]]:</span>
        <span class="n">prefetch_hit_pairs</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span>
            <span class="p">[(</span><span class="n">doc</span><span class="p">,</span> <span class="n">emb</span><span class="p">)</span> <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hits_ite</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Unable to retrieve the server-side embedding of the query."</span>
            <span class="k">raise</span> <span class="n">AstraDBVectorStoreError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mmr_hits</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">sort_vec</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="n">prefetch_hit_pairs</span><span class="o">=</span><span class="n">prefetch_hit_pairs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_mmr_hits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">prefetch_hit_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="n">mmr_chosen_indices</span> <span class="o">=</span> <span class="n">maximal_marginal_relevance</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">[</span><span class="n">hit_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit_pair</span> <span class="ow">in</span> <span class="n">prefetch_hit_pairs</span><span class="p">],</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">hit_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pf_hit_index</span><span class="p">,</span> <span class="n">hit_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prefetch_hit_pairs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pf_hit_index</span> <span class="ow">in</span> <span class="n">mmr_chosen_indices</span>
        <span class="p">]</span>

<div class="viewcode-block" id="AstraDBVectorStore.max_marginal_relevance_search_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.max_marginal_relevance_search_by_vector">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_marginal_relevance_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs selected using the maximal marginal relevance.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">        among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return.</span>
<span class="sd">            fetch_k: Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">            lambda_mult: Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents selected by maximal marginal relevance.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_mmr_find_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">embedding</span><span class="p">),</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.amax_marginal_relevance_search_by_vector">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.amax_marginal_relevance_search_by_vector">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">amax_marginal_relevance_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs selected using the maximal marginal relevance.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">        among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return.</span>
<span class="sd">            fetch_k: Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">            lambda_mult: Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents selected by maximal marginal relevance.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arun_mmr_find_by_sort</span><span class="p">(</span>
            <span class="n">sort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vector_sort</span><span class="p">(</span><span class="n">embedding</span><span class="p">),</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.max_marginal_relevance_search">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.max_marginal_relevance_search">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_marginal_relevance_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs selected using the maximal marginal relevance.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">        among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return.</span>
<span class="sd">            fetch_k: Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">            lambda_mult: Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents selected by maximal marginal relevance.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">"Method `max_marginal_relevance_search` was called on a vector "</span>
                    <span class="s2">"store equipped with Hybrid capabilities. Since this method cannot "</span>
                    <span class="s2">"make use of Hybrid search, the vector store will fall back to "</span>
                    <span class="s2">"regular vector ANN similarity search."</span>
                <span class="p">),</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="c1"># this case goes directly to the "_by_sort" method</span>
            <span class="c1"># (and does its own filter normalization, as it cannot</span>
            <span class="c1">#  use the path for the with-embedding mmr querying)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_mmr_find_by_sort</span><span class="p">(</span>
                <span class="n">sort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vectorize_sort</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
                <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_relevance_search_by_vector</span><span class="p">(</span>
            <span class="n">embedding_vector</span><span class="p">,</span>
            <span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.amax_marginal_relevance_search">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.amax_marginal_relevance_search">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">amax_marginal_relevance_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return docs selected using the maximal marginal relevance.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">        among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return.</span>
<span class="sd">            fetch_k: Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">            lambda_mult: Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">            filter: Filter on the metadata to apply.</span>
<span class="sd">            **kwargs: Additional arguments are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of Documents selected by maximal marginal relevance.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">"Method `amax_marginal_relevance_search` was called on a vector "</span>
                    <span class="s2">"store equipped with Hybrid capabilities. Since this method cannot "</span>
                    <span class="s2">"make use of Hybrid search, the vector store will fall back to "</span>
                    <span class="s2">"regular vector ANN similarity search."</span>
                <span class="p">),</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">server_side_embeddings</span><span class="p">:</span>
            <span class="c1"># this case goes directly to the "_by_sort" method</span>
            <span class="c1"># (and does its own filter normalization, as it cannot</span>
            <span class="c1">#  use the path for the with-embedding mmr querying)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arun_mmr_find_by_sort</span><span class="p">(</span>
                <span class="n">sort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document_codec</span><span class="o">.</span><span class="n">encode_vectorize_sort</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
                <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_safe_embedding</span><span class="p">()</span><span class="o">.</span><span class="n">aembed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">amax_marginal_relevance_search_by_vector</span><span class="p">(</span>
            <span class="n">embedding_vector</span><span class="p">,</span>
            <span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_kwargs</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">AstraDBVectorStore</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBVectorStore</span><span class="p">:</span>
        <span class="n">_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">AstraDBVectorStore</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">AstraDBVectorStore</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">kwonlyargs</span>
        <span class="n">known_kwarg_keys</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">))</span> <span class="o">-</span> <span class="p">{</span><span class="s2">"self"</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">unknown_kwarg_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">known_kwarg_keys</span>
            <span class="k">if</span> <span class="n">unknown_kwarg_keys</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">"Method 'from_texts/afrom_texts' of AstraDBVectorStore "</span>
                        <span class="s2">"vector store invoked with unsupported arguments "</span>
                        <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_kwarg_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">), "</span>
                        <span class="s2">"which will be ignored."</span>
                    <span class="p">),</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">known_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">known_kwarg_keys</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">known_kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="AstraDBVectorStore.from_texts">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.from_texts">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_texts</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">AstraDBVectorStore</span><span class="p">],</span>
        <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBVectorStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an Astra DB vectorstore from raw texts.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: the texts to insert.</span>
<span class="sd">            embedding: the embedding function to use in the store.</span>
<span class="sd">            metadatas: metadata dicts for the texts.</span>
<span class="sd">            ids: ids to associate to the texts.</span>
<span class="sd">            **kwargs: you can pass any argument that you would</span>
<span class="sd">                to :meth:`~add_texts` and/or to the</span>
<span class="sd">                ``AstraDBVectorStore`` constructor (see these methods for</span>
<span class="sd">                details). These arguments will be</span>
<span class="sd">                routed to the respective methods as they are.</span>

<span class="sd">        Returns:</span>
<span class="sd">            an ``AstraDBVectorStore`` vectorstore.</span>
<span class="sd">        """</span>
        <span class="n">_add_texts_inspection</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">AstraDBVectorStore</span><span class="o">.</span><span class="n">add_texts</span><span class="p">)</span>
        <span class="n">_method_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">_add_texts_inspection</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">)</span>
            <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">_add_texts_inspection</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">"self"</span><span class="p">,</span> <span class="s2">"texts"</span><span class="p">,</span> <span class="s2">"metadatas"</span><span class="p">,</span> <span class="s2">"ids"</span><span class="p">}</span>
        <span class="n">_init_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_method_args</span><span class="p">}</span>
        <span class="n">_method_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_method_args</span><span class="p">}</span>
        <span class="n">astra_db_store</span> <span class="o">=</span> <span class="n">AstraDBVectorStore</span><span class="o">.</span><span class="n">_from_kwargs</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_init_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">astra_db_store</span><span class="o">.</span><span class="n">add_texts</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_method_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">astra_db_store</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.afrom_texts">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.afrom_texts">[docs]</a>
    <span class="nd">@override</span>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">afrom_texts</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">AstraDBVectorStore</span><span class="p">],</span>
        <span class="n">texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBVectorStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an Astra DB vectorstore from raw texts.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: the texts to insert.</span>
<span class="sd">            embedding: embedding function to use.</span>
<span class="sd">            metadatas: metadata dicts for the texts.</span>
<span class="sd">            ids: ids to associate to the texts.</span>
<span class="sd">            **kwargs: you can pass any argument that you would</span>
<span class="sd">                to :meth:`~aadd_texts` and/or to the ``AstraDBVectorStore``</span>
<span class="sd">                constructor (see these methods for details). These arguments</span>
<span class="sd">                will be routed to the respective methods as they are.</span>

<span class="sd">        Returns:</span>
<span class="sd">            an ``AstraDBVectorStore`` vectorstore.</span>
<span class="sd">        """</span>
        <span class="n">_aadd_texts_inspection</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">AstraDBVectorStore</span><span class="o">.</span><span class="n">aadd_texts</span><span class="p">)</span>
        <span class="n">_method_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">_aadd_texts_inspection</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">)</span>
            <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">_aadd_texts_inspection</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">"self"</span><span class="p">,</span> <span class="s2">"texts"</span><span class="p">,</span> <span class="s2">"metadatas"</span><span class="p">,</span> <span class="s2">"ids"</span><span class="p">}</span>
        <span class="n">_init_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_method_args</span><span class="p">}</span>
        <span class="n">_method_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_method_args</span><span class="p">}</span>
        <span class="n">astra_db_store</span> <span class="o">=</span> <span class="n">AstraDBVectorStore</span><span class="o">.</span><span class="n">_from_kwargs</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_init_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">astra_db_store</span><span class="o">.</span><span class="n">aadd_texts</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_method_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">astra_db_store</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.from_documents">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.from_documents">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_documents</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">AstraDBVectorStore</span><span class="p">],</span>
        <span class="n">documents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBVectorStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an Astra DB vectorstore from a document list.</span>

<span class="sd">        Utility method that defers to :meth:`from_texts` (see that one).</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: the texts to insert.</span>
<span class="sd">            documents: a list of `Document` objects for insertion in the store.</span>
<span class="sd">            embedding: the embedding function to use in the store.</span>
<span class="sd">            **kwargs: you can pass any argument that you would</span>
<span class="sd">                to :meth:`~add_texts` and/or to the</span>
<span class="sd">                ``AstraDBVectorStore`` constructor (see these methods for</span>
<span class="sd">                details). These arguments will be</span>
<span class="sd">                routed to the respective methods as they are.</span>

<span class="sd">        Returns:</span>
<span class="sd">            an ``AstraDBVectorStore`` vectorstore.</span>
<span class="sd">        """</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">"ids"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">"Parameter `ids` to AstraDBVectorStore's `from_documents` "</span>
                    <span class="s2">"method is deprecated. Please set the supplied documents' "</span>
                    <span class="s2">"`.id` attribute instead. The id attribute of Document "</span>
                    <span class="s2">"is ignored as long as the `ids` parameter is passed."</span>
                <span class="p">),</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"ids"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">_ids</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">the_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">the_id</span> <span class="ow">in</span> <span class="n">_ids</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_texts</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AstraDBVectorStore.afrom_documents">
<a class="viewcode-back" href="../../astradb/vectorstores/langchain_astradb.vectorstores.AstraDBVectorStore.html#langchain_astradb.vectorstores.AstraDBVectorStore.afrom_documents">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">afrom_documents</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">AstraDBVectorStore</span><span class="p">],</span>
        <span class="n">documents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AstraDBVectorStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an Astra DB vectorstore from a document list.</span>

<span class="sd">        Utility method that defers to :meth:`afrom_texts` (see that one).</span>

<span class="sd">        Args: see :meth:`afrom_texts`, except here you have to supply ``documents``</span>
<span class="sd">            in place of ``texts`` and ``metadatas``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            an ``AstraDBVectorStore`` vectorstore.</span>
<span class="sd">        """</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">"ids"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">"Parameter `ids` to AstraDBVectorStore's `from_documents` "</span>
                    <span class="s2">"method is deprecated. Please set the supplied documents' "</span>
                    <span class="s2">"`.id` attribute instead. The id attribute of Document "</span>
                    <span class="s2">"is ignored as long as the `ids` parameter is passed."</span>
                <span class="p">),</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"ids"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">_ids</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">the_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">the_id</span> <span class="ow">in</span> <span class="n">_ids</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">afrom_texts</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>
</article>
</div>
</div>
<footer class="bd-footer-content">
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script defer="" src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer="" src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>
<footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
<div class="footer-items__start">
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2025, LangChain Inc.
      <br/>
</p>
</div>
</div>
</div>
</footer>
</body>
</html>